<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ è¯´æˆ‘çŒœ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ–°å¢ï¼šå½•åˆ¶ç›¸å…³æ ·å¼ */
        .recording-indicator {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 59, 48, 0.9);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        z-index: 1002;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: pulse 1.5s infinite;
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        display: none;
        }

        .camera-preview {
        position: fixed;
        top: 0;
        right: 0;
        width: 120px;
        height: 160px;
        background: #000;
        border: 2px solid #2575fc;
        border-radius: 8px;
        z-index: 1001;
        overflow: hidden;
        opacity: 0.9;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        display: none;
        }

        .camera-preview video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        }

        .recording-time {
        font-size: 12px;
        margin-left: 5px;
        opacity: 0.9;
        }

        @keyframes pulse {

        0%,
        100% {
        opacity: 1;
        }

        50% {
        opacity: 0.7;
        }
        }

        .record-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #ff4757;
        border: 3px solid white;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        transition: all 0.3s ease;
        }

        .record-btn.recording {
        background: #2575fc;
        animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {

        0%,
        100% {
        transform: scale(1);
        }

        50% {
        transform: scale(1.05);
        }
        }

        .permission-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1003;
        display: flex;
        align-items: center;
        justify-content: center;
        display: none;
        }

        .permission-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        margin: 20px;
        }

        .permission-content h3 {
        color: #2575fc;
        margin-bottom: 15px;
        }

        .permission-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        }

        /* ä¿®æ”¹è®¡æ—¶å™¨ç´§å¼ çŠ¶æ€æ ·å¼ */
        .timer.timer-low {
        color: #ff4757 !important;
        /* çº¢è‰²æ›´ç´§å¼  */
        animation: urgentPulse 0.3s infinite !important;
        }

        @keyframes urgentPulse {

        0%,
        100% {
        opacity: 1;
        transform: scale(1);
        text-shadow: 0 0 10px #ff4757;
        }

        50% {
        opacity: 0.7;
        transform: scale(1.05);
        text-shadow: 0 0 20px #ff4757;
        }
        }

        /* æ–°å¢ï¼šéŸ³æ•ˆæ§åˆ¶ç›¸å…³æ ·å¼ */
        /* æ–°å¢ï¼šéŸ³æ•ˆæ§åˆ¶ç›¸å…³æ ·å¼ */
        .audio-controls {
        position: fixed;
        /* å›ºå®šåœ¨é¡µé¢ä¸­ï¼Œä¸éšæ»šåŠ¨ç§»åŠ¨ */
        top: 4px;
        /* è·ç¦»é¡¶éƒ¨12åƒç´ ï¼ˆåŸ15pxï¼‰ */
        right: 6px;
        /* è·ç¦»å³ä¾§12åƒç´ ï¼ˆåŸ15pxï¼‰ */
        z-index: 1000;
        /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚æ˜¾ç¤º */
        }

        .audio-toggle {
        width: 36px;
        /* æŒ‰é’®å®½åº¦36åƒç´ ï¼ˆåŸ42pxï¼‰ */
        height: 36px;
        /* æŒ‰é’®é«˜åº¦36åƒç´ ï¼ˆåŸ42pxï¼‰ */
        border-radius: 50%;
        /* 50%è¾¹æ¡†åŠå¾„åˆ›å»ºåœ†å½¢æŒ‰é’® */
        background: rgba(255, 255, 255, 0.95);
        /* ç™½è‰²èƒŒæ™¯ï¼Œ95%ä¸é€æ˜åº¦ */
        border: 1.5px solid #2575fc;
        /* 1.5åƒç´ è“è‰²è¾¹æ¡†ï¼ˆåŸ2pxï¼‰ */
        color: #2575fc;
        /* å›¾æ ‡é¢œè‰²ä¸ºè“è‰² */
        font-size: 1rem;
        /* å›¾æ ‡å¤§å°1remï¼ˆåŸ1.2remï¼‰ */
        cursor: pointer;
        /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        display: flex;
        /* ä½¿ç”¨Flexå¸ƒå±€ */
        align-items: center;
        /* å‚ç›´å±…ä¸­å›¾æ ‡ */
        justify-content: center;
        /* æ°´å¹³å±…ä¸­å›¾æ ‡ */
        transition: all 0.25s ease;
        /* æ‰€æœ‰å±æ€§0.25ç§’ç¼“åŠ¨è¿‡æ¸¡æ•ˆæœ */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        /* æ›´è½»å¾®çš„é˜´å½±æ•ˆæœ */
        }

        .audio-toggle:hover {
        transform: scale(1.05);
        /* é¼ æ ‡æ‚¬åœæ—¶æ”¾å¤§1.05å€ï¼ˆåŸ1.08ï¼‰ */
        background: #2575fc;
        /* æ‚¬åœæ—¶èƒŒæ™¯å˜ä¸ºè“è‰² */
        color: white;
        /* æ‚¬åœæ—¶å›¾æ ‡å˜ä¸ºç™½è‰² */
        }

        .audio-toggle.muted {
        background: #ff4757;
        /* é™éŸ³çŠ¶æ€èƒŒæ™¯å˜ä¸ºçº¢è‰² */
        border-color: #ff4757;
        /* é™éŸ³çŠ¶æ€è¾¹æ¡†å˜ä¸ºçº¢è‰² */
        color: white;
        /* é™éŸ³çŠ¶æ€å›¾æ ‡å˜ä¸ºç™½è‰² */
        }

        /* å€’è®¡æ—¶éŸ³æ•ˆæç¤º */
        .countdown-audio-hint {
        position: absolute;
        /* ç»å¯¹å®šä½ */
        bottom: 6px;
        /* è·ç¦»åº•éƒ¨6åƒç´ ï¼ˆåŸ8pxï¼‰ */
        left: 50%;
        /* æ°´å¹³å±…ä¸­èµ·ç‚¹ */
        transform: translateX(-50%);
        /* æ°´å¹³å±…ä¸­è°ƒæ•´ */
        color: rgba(255, 255, 255, 0.8);
        /* ç™½è‰²æ–‡å­—ï¼Œ80%ä¸é€æ˜åº¦ */
        font-size: 0.75rem;
        /* æ–‡å­—å¤§å°0.75remï¼ˆåŸ0.8remï¼‰ */
        text-align: center;
        /* æ–‡å­—å±…ä¸­ */
        display: none;
        /* é»˜è®¤éšè— */
        }

        /* å½“å€’è®¡æ—¶è¦†ç›–å±‚æ¿€æ´»æ—¶æ˜¾ç¤ºéŸ³æ•ˆæç¤º */
        .countdown-overlay.active .countdown-audio-hint {
        display: block;
        /* æ˜¾ç¤ºéŸ³æ•ˆæç¤º */
        animation: fadeInUp 0.4s ease;
        /* æ·¡å…¥ä¸Šç§»åŠ¨ç”»ï¼Œæ—¶é—´ç¼©çŸ­ */
        }

        @keyframes fadeInUp {
        from {
        opacity: 0;
        /* å¼€å§‹å®Œå…¨é€æ˜ */
        transform: translateX(-50%) translateY(6px);
        /* å¼€å§‹ä½ç½®ä¸‹ç§»6åƒç´ ï¼ˆåŸ8pxï¼‰ */
        }

        to {
        opacity: 1;
        /* ç»“æŸå®Œå…¨ä¸é€æ˜ */
        transform: translateX(-50%) translateY(0);
        /* ç»“æŸä½ç½®æ¢å¤æ­£å¸¸ */
        }
        }

        /* éŸ³æ•ˆåŠ è½½çŠ¶æ€ */
        .audio-loading {
        position: absolute;
        /* ç»å¯¹å®šä½ */
        top: 50%;
        /* å‚ç›´å±…ä¸­èµ·ç‚¹ */
        left: 50%;
        /* æ°´å¹³å±…ä¸­èµ·ç‚¹ */
        transform: translate(-50%, -50%);
        /* å®Œå…¨å±…ä¸­ */
        color: white;
        /* ç™½è‰²æ–‡å­— */
        font-size: 0.65rem;
        /* æ–‡å­—å¤§å°0.65remï¼ˆåŸ0.7remï¼‰ */
        text-align: center;
        /* æ–‡å­—å±…ä¸­ */
        opacity: 0.7;
        /* 70%ä¸é€æ˜åº¦ */
        }

        * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        }

        body {
        font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: #333;
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden;
        }

        .container {
        max-width: 500px;
        margin: 0 auto;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        padding: 25px;
        position: relative;
        }

        .header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        }

        h1 {
        color: #2575fc;
        font-size: 2.2rem;
        margin-bottom: 8px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
        color: #666;
        font-size: 1rem;
        font-weight: 400;
        }

        .game-section {
        display: none;
        text-align: center;
        }

        .active-section {
        display: block;
        animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
        from {
        opacity: 0;
        transform: translateY(10px);
        }

        to {
        opacity: 1;
        transform: translateY(0);
        }
        }

        .theme-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 25px 0;
        }

        .theme-card {
        background: white;
        border-radius: 18px;
        padding: 20px 10px;
        min-height: 120px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        }

        .theme-card:hover,
        .theme-card:active {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .theme-card.selected {
        border-color: #2575fc;
        background-color: #f0f7ff;
        }

        .theme-icon {
        font-size: 2rem;
        margin-bottom: 8px;
        }

        .theme-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        }

        .time-options {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 25px 0;
        }

        .time-option {
        padding: 15px 25px;
        background: #f0f7ff;
        border-radius: 15px;
        font-size: 1.3rem;
        font-weight: 700;
        color: #2575fc;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
        border: 2px solid transparent;
        }

        .time-option:hover,
        .time-option:active {
        background: #2575fc;
        color: white;
        }

        .time-option.selected {
        background: #2575fc;
        color: white;
        border-color: #1c5dc1;
        box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
        }

        .game-area {
        margin: 30px 0;
        position: relative;
        }

        .word-card {
        background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
        color: white;
        padding: 40px 20px;
        border-radius: 20px;
        font-size: 2.8rem;
        font-weight: 700;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(37, 117, 252, 0.3);
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        word-break: break-word;
        }

        .timer {
        font-size: 3.5rem;
        font-weight: 800;
        color: #294dde;
        margin: 20px 0;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .timer-ms {
        font-size: 1.8rem;
        color: #2c48d7;
        margin-top: -10px;
        }

        .game-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
        }

        .btn {
        padding: 18px 35px;
        border-radius: 15px;
        font-size: 1.2rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        min-width: 160px;
        }

        .btn-primary {
        background: #2575fc;
        color: white;
        box-shadow: 0 8px 20px rgba(37, 117, 252, 0.3);
        }

        .btn-primary:hover,
        .btn-primary:active {
        background: #1c5dc1;
        transform: translateY(-3px);
        }

        .btn-secondary {
        background: #f1f2f6;
        color: #333;
        border: 2px solid #ddd;
        }

        .btn-secondary:hover,
        .btn-secondary:active {
        background: #e0e2e9;
        }

        .btn-success {
        background: #2ed573;
        color: white;
        box-shadow: 0 8px 20px rgba(46, 213, 115, 0.3);
        }

        .btn-success:hover,
        .btn-success:active {
        background: #25b562;
        transform: translateY(-3px);
        }

        .btn-info {
        background: #2dd1db;
        color: white;
        box-shadow: 0 8px 20px rgba(45, 209, 219, 0.3);
        }

        .btn-info:hover,
        .btn-info:active {
        background: #25a4ac;
        transform: translateY(-3px);
        }

        .shake-hint {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 15px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        /* ç¡®ä¿å‚ç›´å±…ä¸­ */
        justify-content: center;
        gap: 15px;
        /* å¢åŠ é—´è· */
        color: #666;
        font-size: 1rem;
        border: 2px dashed #2575fc;
        min-height: 80px;
        /* è®¾ç½®æœ€å°é«˜åº¦ */
        }

        .shake-hint>div {
        text-align: left;
        line-height: 1.4;
        }

        .shake-hint p {
        margin: 2px 0;
        }

        /* æ¸¸æˆç•Œé¢çš„æ‰‹åŠ¿æç¤ºéƒ¨åˆ† */
        #gameSection .shake-hint {
        align-items: flex-start;
        padding: 15px;
        align-items: center;
        /* å‚ç›´å±…ä¸­ */
        }

        #gameSection .shake-hint .shake-icon {
        font-size: 2.2rem;
        margin-right: 15px;
        }

        .shake-icon {
        color: #2575fc;
        font-size: 2rem;
        /* ç¨å¾®å¢å¤§å›¾æ ‡ */
        animation: shake 2s infinite;
        flex-shrink: 0;
        /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
        }

        @keyframes shake {

        0%,
        100% {
        transform: rotate(0deg);
        }

        25% {
        transform: rotate(-10deg);
        }

        75% {
        transform: rotate(10deg);
        }
        }

        .result-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin: 25px 0;
        text-align: center;
        }

        .score {
        font-size: 4rem;
        font-weight: 800;
        color: #2575fc;
        margin: 15px 0;
        }

        .result-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 25px 0;
        }

        .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        }

        .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #ff4757;
        }

        #correctCount {
        color: #2ed573 !important;
        }

        #finalCorrect {
        color: #2ed573 !important;
        }

        .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
        }

        /* æ–°å¢ï¼šé‡åŠ›æ„Ÿåº”åé¦ˆæ ·å¼ */
        .gesture-feedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        font-size: 4rem;
        animation: gestureFeedback 0.5s ease;
        pointer-events: none;
        }

        /* é‡åŠ›æ„Ÿåº”çŠ¶æ€æ ·å¼ */
        .motion-status {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        margin: 15px 0;
        border: 2px dashed #ddd;
        display: flex;
        align-items: center;
        gap: 15px;
        min-height: 80px;
        }

        .motion-status.enabled {
        border-color: #2ed573;
        background: rgba(46, 213, 115, 0.1);
        }

        .motion-status.disabled {
        border-color: #ff4757;
        background: rgba(255, 71, 87, 0.1);
        }

        .motion-status i {
        font-size: 2rem;
        }

        .motion-status .status-text {
        flex: 1;
        }

        .motion-status .status-title {
        font-weight: bold;
        margin-bottom: 5px;
        }

        .motion-status .status-desc {
        font-size: 0.9rem;
        color: #666;
        }

        /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
        .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        }

        .btn:disabled:hover {
        transform: none !important;
        }

        @keyframes gestureFeedback {
        0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
        }

        70% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
        }

        100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1);
        }
        }

        /* æ–°å¢ï¼šå€’è®¡æ—¶æ ·å¼ */
        .countdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        }

        .countdown-number {
        font-size: 12rem;
        font-weight: 900;
        color: white;
        text-shadow: 0 0 30px rgba(37, 117, 252, 0.8);
        margin-bottom: 20px;
        animation: countdownPulse 1s ease infinite;
        }

        .countdown-text {
        font-size: 2rem;
        color: white;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        animation: fadeInOut 1s ease infinite;
        }

        @keyframes countdownPulse {
        0% {
        transform: scale(1);
        opacity: 1;
        }

        50% {
        transform: scale(1.2);
        opacity: 0.8;
        }

        100% {
        transform: scale(1);
        opacity: 1;
        }
        }

        @keyframes fadeInOut {

        0%,
        100% {
        opacity: 0.7;
        }

        50% {
        opacity: 1;
        }
        }

        /* æ–°å¢ï¼šå‡†å¤‡ç•Œé¢æ ·å¼ */
        .ready-section {
        text-align: center;
        padding: 40px 20px;
        }

        .ready-title {
        font-size: 2.5rem;
        color: #2575fc;
        margin-bottom: 20px;
        animation: readyPulse 2s ease infinite;
        }

        .ready-hint {
        background: rgba(37, 117, 252, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin: 30px 0;
        border: 2px dashed #2575fc;
        }

        .ready-hint h3 {
        color: #2575fc;
        margin-bottom: 15px;
        font-size: 1.3rem;
        }

        .ready-hint ul {
        text-align: left;
        list-style: none;
        padding: 0;
        }

        .ready-hint li {
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        }

        .ready-hint li i {
        color: #2575fc;
        }

        @keyframes readyPulse {

        0%,
        100% {
        transform: scale(1);
        }

        50% {
        transform: scale(1.05);
        }
        }

        /* æ–°å¢ï¼šå›é¡¾è¯è¯­åˆ—è¡¨æ ·å¼ */
        .review-section {
        margin-top: 25px;
        text-align: left;
        }

        .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        }

        .review-header h3 {
        color: #2575fc;
        font-size: 1.5rem;
        }

        .review-toggle {
        background: #f0f7ff;
        border: 2px solid #2575fc;
        color: #2575fc;
        border-radius: 10px;
        padding: 8px 15px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        }

        .review-toggle:hover {
        background: #2575fc;
        color: white;
        }

        .review-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
        }

        .review-content.expanded {
        max-height: 400px;
        overflow-y: auto;
        }

        .word-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        padding: 10px 5px;
        }

        .word-item {
        background: white;
        border-radius: 12px;
        padding: 15px 8px;
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        }

        .word-item.correct {
        background: linear-gradient(135deg, #2ed573 0%, #25b562 100%);
        color: white;
        border: 2px solid #25b562;
        }

        .word-item.skipped {
        background: linear-gradient(135deg, #ff6b81 0%, #ff4757 100%);
        color: white;
        border: 2px solid #ff4757;
        }

        .word-item .word-status {
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 0.7rem;
        opacity: 0.9;
        }

        .word-item.correct .word-status {
        content: "âœ“";
        }

        .word-item.skipped .word-status {
        content: "â†’";
        }

        .review-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 0.9rem;
        }

        .review-stat {
        display: flex;
        align-items: center;
        gap: 5px;
        }

        .review-stat.correct {
        color: #2ed573;
        }

        .review-stat.skipped {
        color: #ff4757;
        }

        @media (max-width: 500px) {
        .container {
        padding: 20px;
        border-radius: 20px;
        }

        h1 {
        font-size: 1.8rem;
        }



        .word-card {
        font-size: 2.2rem;
        min-height: 160px;
        padding: 30px 15px;
        }

        .timer {
        font-size: 2.8rem;
        }

        .timer-ms {
        font-size: 1.4rem;
        }

        .countdown-number {
        font-size: 8rem;
        }

        .countdown-text {
        font-size: 1.5rem;
        }

        .ready-title {
        font-size: 2rem;
        }

        .game-controls {
        flex-direction: column;
        align-items: center;
        }

        .btn {
        width: 100%;
        max-width: 300px;
        }

        .word-list {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        }

        .word-item {
        padding: 12px 6px;
        font-size: 1rem;
        }
        }

        .loader {
        display: none;
        text-align: center;
        padding: 40px;
        }

        .spinner {
        border: 5px solid rgba(37, 117, 252, 0.2);
        border-top: 5px solid #2575fc;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
        }

        @keyframes spin {
        0% {
        transform: rotate(0deg);
        }

        100% {
        transform: rotate(360deg);
        }
        }

        .timer-area {
        margin: 20px 0;
        }

        .timer {
        font-size: 3.5rem;
        font-weight: 800;
        color: #2575fc;
        margin: 0;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: baseline;
        justify-content: center;
        }

        .timer-ms {
        font-size: 1.8rem;
        font-weight: 700;
        margin-left: 2px;
        }

        /* è®¡æ—¶å™¨ç´§å¼ çŠ¶æ€æ ·å¼è°ƒæ•´ */
        .timer.timer-low {
        color: #293ed9;
        animation: pulse 1s infinite;
        }

        .timer.timer-low .timer-ms {
        color: #6c47ff;
        }

        @keyframes pulse {

        0%,
        100% {
        opacity: 1;
        }

        50% {
        opacity: 0.7;
        }
        }

        @keyframes rotateClockwise {
        from {
        transform: rotate(0deg);
        }

        to {
        transform: rotate(360deg);
        }
        }

        @keyframes rotateCounterclockwise {
        from {
        transform: rotate(0deg);
        }

        to {
        transform: rotate(-360deg);
        }
        }

        .rotate-clockwise {
        animation: rotateClockwise 0.5s ease;
        }

        .rotate-counterclockwise {
        animation: rotateCounterclockwise 0.5s ease;
        }

        /* æ‰‹åŠ¿æç¤ºæ ·å¼æ›´æ–° */
        .gesture-instructions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        text-align: left;
        width: 100%;
        }

        .gesture-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        color: #333;
        }

        .gesture-icon {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
        }

        .correct-icon {
        color: #2ed573;
        }

        .skip-icon {
        color: #ff9f43;
        }

        #themeSection {
        padding-top: 20px;
        /* å¢åŠ æ•´ä¸ªsectionçš„é¡¶éƒ¨å†…è¾¹è· */
        }

        /* ä¸»é¢˜é€‰æ‹©ç•Œé¢çš„æç¤ºä¹Ÿéœ€è¦ç›¸åº”è°ƒæ•´ */
        #themeSection .shake-hint {
        align-items: flex-start;
        padding: 15px;
        align-items: center;
        /* å‚ç›´å±…ä¸­ */
        }

        #themeSection .shake-hint .shake-icon {
        font-size: 2.2rem;
        margin-right: 15px;
        }

        #themeSection .gesture-instructions {
        gap: 6px;
        }

        #themeSection .gesture-item {
        font-size: 0.95rem;
        }

        /* ä¿®æ”¹åŸæ¥çš„pæ ‡ç­¾æ ·å¼ */
        #resultSection .result-card>p {
        text-align: center;
        color: #666;
        font-size: 1.1rem;
        margin: 10px 0 20px 0;
        width: 100%;
        }

        /* ç¡®ä¿h2å®Œå…¨å±…ä¸­ */
        #resultSection .result-card>h2 {
        text-align: center;
        width: 100%;
        color: #2575fc;
        font-size: 2rem;
        margin-bottom: 10px;
        }

        #requestMotionBtn {
        width: 212px;
        /* æˆ–ä»»æ„ä½ æƒ³è¦çš„å®½åº¦ */
        max-width: 212px;
        /* å¯é€‰ï¼šé™åˆ¶æœ€å¤§å®½åº¦ */
        white-space: nowrap;
        /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        overflow: hidden;
        /* éšè—æº¢å‡ºå†…å®¹ */
        text-overflow: ellipsis;
        /* æ–‡å­—è¿‡é•¿æ˜¾ç¤ºçœç•¥å· */
        margin-top: -10px;
        /* å‘ä¸Šç§»åŠ¨10px */
        }


        /* ==================== æ–°å¢ï¼šåº•éƒ¨åé¦ˆå…¥å£å’Œå¼¹çª—æ ·å¼ ==================== */
        /* å…¨å±€åº•éƒ¨åé¦ˆå…¥å£ */
        .global-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 14px 0;
        text-align: center;
        z-index: 999;
        box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15);
        border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .feedback-link {
        color: white;
        text-decoration: none;
        font-size: 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        padding: 8px 20px;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        }

        .feedback-link:hover,
        .feedback-link:active {
        transform: translateY(-3px);
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* ä¸ºé¡µé¢å†…å®¹æ·»åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
        body {
        padding-bottom: 65px;
        }

        /* åé¦ˆå¼¹çª—æ ·å¼ */
        .feedback-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1001;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
        }

        .modal-content {
        background: white;
        margin: 20px auto;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        border-radius: 20px;
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
        from {
        transform: translateY(50px);
        opacity: 0;
        }

        to {
        transform: translateY(0);
        opacity: 1;
        }
        }

        .close-modal {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        }

        .close-modal:hover {
        background: #f0f0f0;
        color: #333;
        }

        /* å¼€å‘è€…ä¿¡æ¯ */
        .developer-info {
        display: flex;
        align-items: center;
        gap: 18px;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        }

        .developer-avatar img {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 3px solid #667eea;
        object-fit: cover;
        }

        .developer-message p {
        margin: 6px 0;
        line-height: 1.5;
        }

        .developer-email {
        color: #667eea;
        font-weight: 600;
        font-size: 15px;
        }

        .developer-email a {
        color: #667eea;
        text-decoration: none;
        padding: 3px 8px;
        border-radius: 6px;
        background: rgba(102, 126, 234, 0.1);
        }

        .developer-email a:hover {
        background: rgba(102, 126, 234, 0.2);
        }

        /* å¯¹è¯åŒºåŸŸ */
        .chat-area {
        margin: 25px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        }

        .message-bubble {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        animation: fadeIn 0.5s ease;
        }

        .message-avatar img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 2px solid #2575fc;
        object-fit: cover;
        }

        .message-content {
        background: white;
        padding: 16px 20px;
        border-radius: 18px;
        max-width: 85%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        }

        .message-content:after {
        content: '';
        position: absolute;
        left: -8px;
        top: 20px;
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid white;
        }

        .message-content p {
        margin: 0;
        color: #333;
        font-size: 15px;
        line-height: 1.5;
        }

        /* ç”¨æˆ·è¾“å…¥åŒºåŸŸ */
        .user-input-area {
        margin-top: 25px;
        }

        #userMessage {
        width: 100%;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 15px;
        resize: vertical;
        min-height: 120px;
        margin-bottom: 20px;
        font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        transition: all 0.3s ease;
        }

        #userMessage:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        #sendEmailBtn {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        }

        #sendEmailBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        /* æ‰“èµåŒºåŸŸ */
        .donation-section {
        margin-top: 30px;
        padding-top: 25px;
        border-top: 2px dashed #e0e0e0;
        text-align: center;
        }

        .donation-section h4 {
        color: #ef2121;
        margin-bottom: 12px;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        }

        .donation-section p {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
        }

        .qrcode-container {
        margin-top: 20px;
        display: block;
        /* æ”¹ä¸º block æ‰èƒ½å±…ä¸­ */
        text-align: center;
        /* ä½¿å…¶å†…å®¹å±…ä¸­ */
        padding: 15px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #eee;
        margin: 20px auto 0 auto;
        /* è‡ªåŠ¨å·¦å³è¾¹è·ç¡®ä¿æ°´å¹³å±…ä¸­ */
        width: fit-content;
        /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
        }

        .donation-qrcode {
        width: 200px;
        height: 200px;
        object-fit: contain;
        border-radius: 8px;
        }

        .qrcode-hint {
        color: #666;
        font-size: 13px;
        margin-top: 12px;
        font-style: italic;
        }

        /* å¼¹çª—å†…çš„è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .modal-content::-webkit-scrollbar {
        width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
        .modal-content {
        width: 95%;
        margin: 10px auto;
        padding: 20px 15px;
        max-height: 90vh;
        }

        .donation-qrcode {
        width: 180px;
        height: 180px;
        }

        .developer-avatar img {
        width: 60px;
        height: 60px;
        }

        .message-avatar img {
        width: 40px;
        height: 40px;
        }

        .message-content {
        max-width: 80%;
        padding: 14px 18px;
        }

        .global-footer {
        padding: 12px 0;
        }

        .feedback-link {
        font-size: 14px;
        padding: 8px 16px;
        }

        body {
        padding-bottom: 60px;
        }
        }

        @media (max-width: 480px) {
        .donation-qrcode {
        width: 160px;
        height: 160px;
        }

        .developer-info {
        flex-direction: column;
        text-align: center;
        gap: 12px;
        }

        .message-bubble {
        gap: 12px;
        }
        }
    </style>
</head>

<body>

<!-- æ–°å¢ï¼šéŸ³æ•ˆæ§åˆ¶æŒ‰é’® -->
<div class="audio-controls">
    <button id="audioToggle" class="audio-toggle" title="åˆ‡æ¢éŸ³æ•ˆ">
        <i class="fas fa-volume-up"></i>
    </button>
</div>

<!-- æ–°å¢ï¼šéŸ³é¢‘å…ƒç´  -->
<audio id="countdownAudio" preload="auto" loop>
    <!-- æˆ‘ä»¬å°†ä½¿ç”¨base64ç¼–ç çš„éŸ³é¢‘æ•°æ®ï¼Œé¿å…å¤–éƒ¨æ–‡ä»¶ä¾èµ– -->
</audio>

<audio id="countdownBeep" preload="auto"></audio>
<audio id="gameStartAudio" preload="auto"></audio>
<!-- å€’è®¡æ—¶è¦†ç›–å±‚ -->
<div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">5</div>
    <div class="countdown-text">å‡†å¤‡å¼€å§‹</div>
    <div class="countdown-audio-hint">
        <i class="fas fa-music"></i> å€’è®¡æ—¶éŸ³æ•ˆå·²å¼€å¯
    </div>
</div>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-gamepad"></i>ä½ è¯´æˆ‘çŒœ</h1>
    </div>
    <!-- åœ¨themeSectionçš„æ¸¸æˆæ§åˆ¶åŒºåŸŸä¸Šæ–¹æ·»åŠ  -->
    <div class="game-controls" style="margin-top: 4px;">
        <button class="btn btn-info" id="requestMotionBtn">
            <i class="fas fa-mobile-alt"></i> å¯ç”¨é‡åŠ›æ„Ÿåº”
        </button>
    </div>

    <!-- åœ¨shake-hintä¸Šæ–¹æ·»åŠ çŠ¶æ€æ˜¾ç¤º -->
    <!-- <div id="motionStatus" class="shake-hint" style="margin-top: 4px; background: #f8f9fa; display: none;">
           <i class="fas fa-check-circle" style="color: #2ed573;"></i>
           <div>
               <p style="font-weight: bold; color: #2ed573;">âœ“ é‡åŠ›æ„Ÿåº”å·²å¯ç”¨</p>
               <p style="font-size: 0.9rem;">ç°åœ¨å¯ä»¥ä½¿ç”¨æ‰‹æœºæ—‹è½¬æ¥æ§åˆ¶æ¸¸æˆ</p>
           </div>
       </div> -->
    <section id="themeSection" class="game-section active-section">
        <h2>é€‰æ‹©çŒœè¯ä¸»é¢˜</h2>
        <div class="theme-grid" id="themeGrid">
            <!-- ä¸»é¢˜å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="time-options" id="timeOptions">
            <!-- æ—¶é—´é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ·»åŠ éšè—çš„è¯åº“ç®¡ç†æŒ‰é’® -->

        <div class="game-controls">
            <button class="btn btn-primary" id="startGameBtn">
                <i class="fas fa-play-circle"></i>è¿›å…¥æ¸¸æˆ
            </button>
        </div>

        <div class="shake-hint">
            <i class="fas fa-mobile-alt shake-icon"></i>
            <div>
                <p>ğŸ“± æ‰‹åŠ¿æ§åˆ¶ï¼š</p>
                <p>é¡ºæ—¶é’ˆæ™ƒåŠ¨ = çŒœå¯¹</p>
                <p>é€†æ—¶é’ˆæ™ƒåŠ¨ = è·³è¿‡</p>
            </div>
        </div>
        <button id="manageWordsBtn" style="
           position: absolute;
           top: 10px;
           right: 10px;
           width: 30px;
           height: 30px;
           background: transparent;
           border: none;
           opacity: 0.001;
           z-index: 1000;
           cursor: pointer;
       ">
            <i class="fas fa-tools" style="opacity: 0;"></i>
        </button>
    </section>

    <!-- æ–°å¢ï¼šå‡†å¤‡ç•Œé¢ -->
    <section id="readySection" class="game-section">
        <div class="ready-section">
            <h2 class="ready-title">å‡†å¤‡å¼€å§‹!</h2>
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 30px;">
                ä¸»é¢˜: <span id="readyTheme">æˆè¯­</span> Â· æ—¶é—´: <span id="readyTime">2</span>åˆ†é’Ÿ
            </p>

            <div class="ready-hint">
                <h3><i class="fas fa-lightbulb"></i> æ¸¸æˆæç¤º</h3>
                <ul>
                    <li><i class="fas fa-check-circle"></i> é¡ºæ—¶é’ˆæ—‹è½¬æ‰‹æœº = çŒœå¯¹</li>
                    <li><i class="fas fa-forward"></i> é€†æ—¶é’ˆæ—‹è½¬æ‰‹æœº = è·³è¿‡</li>
                    <li><i class="fas fa-mobile-alt"></i> ä¿æŒæ‰‹æœºç«–ç›´ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li>
                    <li><i class="fas fa-bolt"></i> åŠ¨ä½œè¦å¿«é€Ÿæœæ–­ï¼Œæ—‹è½¬çº¦15åº¦å³å¯</li>
                </ul>
            </div>

            <div class="game-controls">
                <button class="btn btn-success" id="startNowBtn">
                    <i class="fas fa-rocket"></i> ç«‹å³å¼€å§‹
                </button>
                <button class="btn btn-secondary" id="cancelStartBtn">
                    <i class="fas fa-times"></i> è¿”å›
                </button>
            </div>
        </div>
    </section>

    <section id="gameSection" class="game-section">
        <div class="game-area">
            <h2 id="currentTheme" style="transform: translateY(-9px);">æˆè¯­çŒœçŒœçŒœ</h2>
            <div class="word-card" id="currentWord">
                è¯è¯­åŠ è½½ä¸­...
            </div>

            <div class="timer-area">
                <div class="timer" id="timer">
                    03:00
                    <span class="timer-ms" id="timerMs">.000</span>
                </div>
            </div>

            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">çŒœå¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="skippedCount">0</div>
                    <div class="stat-label">è·³è¿‡</div>
                </div>
            </div>
        </div>

        <div class="game-controls">
            <button class="btn btn-success" id="correctBtn">
                <i class="fas fa-check-circle"></i> çŒœå¯¹äº†
            </button>
            <button class="btn btn-secondary" id="skipBtn">
                <i class="fas fa-forward"></i> è·³è¿‡
            </button>
            <button class="btn btn-secondary" id="endGameBtn">
                <i class="fas fa-stop-circle"></i> ç»“æŸæ¸¸æˆ
            </button>
        </div>

        <div class="shake-hint">
            <i class="fas fa-mobile-alt shake-icon"></i>
            <div>
                <p>ğŸ“± æ‰‹åŠ¿æ§åˆ¶ï¼š</p>
                <p>é¡ºæ—¶é’ˆæ™ƒåŠ¨ = çŒœå¯¹</p>
                <p>é€†æ—¶é’ˆæ™ƒåŠ¨ = è·³è¿‡</p>
            </div>
        </div>
    </section>

    <section id="resultSection" class="game-section">
        <div class="result-card">
            <div class="result-header">
                <h2>æ¸¸æˆç»“æŸ!</h2>
                <p class="result-subtitle">ä½ çš„æœ€ç»ˆå¾—åˆ†</p>
            </div>
            <!-- <div class="score" id="finalScore">0</div> -->

            <div class="result-stats">
                <div class="stat-item">
                    <div class="stat-value" id="finalCorrect">0</div>
                    <div class="stat-label">çŒœå¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="finalSkipped">0</div>
                    <div class="stat-label">è·³è¿‡</div>
                </div>
            </div>

            <p id="resultMessage">ç»§ç»­åŠ æ²¹ï¼</p>

            <!-- æ–°å¢ï¼šå›é¡¾è¯è¯­åŒºåŸŸ -->
            <div class="review-section">
                <div class="review-header">
                    <h3><i class="fas fa-history"></i> è¯è¯­å›é¡¾</h3>
                    <button class="review-toggle" id="toggleReview">
                        <i class="fas fa-chevron-down"></i> å±•å¼€æŸ¥çœ‹
                    </button>
                </div>

                <div class="review-content" id="reviewContent">
                    <div class="word-list" id="wordReviewList">
                        <!-- å›é¡¾è¯è¯­å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="review-stats">
                        <div class="review-stat correct">
                            <i class="fas fa-check-circle"></i>
                            <span>çŒœå¯¹: <span id="reviewCorrectCount">0</span>ä¸ª</span>
                        </div>
                        <div class="review-stat skipped">
                            <i class="fas fa-forward"></i>
                            <span>è·³è¿‡: <span id="reviewSkippedCount">0</span>ä¸ª</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-controls">
            <button class="btn btn-primary" id="playAgainBtn">
                <i class="fas fa-redo"></i>å†ç©ä¸€æ¬¡
            </button>
            <!-- <button class="btn btn-info" id="showReviewBtn">
                           <i class="fas fa-history"></i>æŸ¥çœ‹å›é¡¾
                       </button> -->
            <button class="btn btn-secondary" id="backToThemeBtn">
                <i class="fas fa-palette"></i>é€‰æ‹©å…¶ä»–ä¸»é¢˜
            </button>
        </div>
    </section>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p>æ¸¸æˆåŠ è½½ä¸­...</p>
    </div>
</div>
<!-- æ–°å¢ï¼šå½•åˆ¶ç›¸å…³å…ƒç´  -->
<div class="camera-preview" id="cameraPreview">
    <video id="cameraVideo" autoplay muted playsinline></video>
</div>

<div class="recording-indicator" id="recordingIndicator">
    <i class="fas fa-circle"></i> å½•åˆ¶ä¸­
    <span class="recording-time" id="recordingTime">00:00</span>
</div>

<!-- <div class="permission-modal" id="permissionModal">
       <div class="permission-content">
           <h3><i class="fas fa-video"></i> å½•åˆ¶åŠŸèƒ½</h3>
           <p>æ¸¸æˆè¿‡ç¨‹ä¸­å°†å½•åˆ¶è§†é¢‘å¹¶å åŠ å½“å‰è¯è¯­ï¼Œéœ€è¦æ‘„åƒå¤´æƒé™ã€‚</p>
           <p><small>è§†é¢‘ä¼šä¿å­˜åœ¨æ‰‹æœºç›¸å†Œä¸­</small></p>
           <div class="permission-actions">
               <button class="btn btn-primary" id="enableRecordingBtn">
                   <i class="fas fa-check"></i> å¯ç”¨å½•åˆ¶
               </button>
               <button class="btn btn-secondary" id="skipRecordingBtn">
                   <i class="fas fa-times"></i> è·³è¿‡å½•åˆ¶
               </button>
           </div>
       </div>
   </div> -->
<!-- ==================== æ–°å¢ï¼šå…¨å±€åº•éƒ¨åé¦ˆå…¥å£ ==================== -->
<div id="globalFooter" class="global-footer">
    <div class="footer-content">
        <a href="#" id="feedbackTrigger" class="feedback-link">
            <i class="fas fa-comment-alt"></i> æ”¯æŒå¼€å‘è€… / åé¦ˆBUG
        </a>
    </div>
</div>

<!-- ==================== æ–°å¢ï¼šåé¦ˆå¼¹çª— ==================== -->
<div id="feedbackModal" class="feedback-modal">
    <div class="modal-content">
        <!-- å…³é—­æŒ‰é’® -->
        <span class="close-modal">&times;</span>

        <!-- å¼€å‘è€…ä¿¡æ¯ -->
        <div class="developer-info">

            <div class="developer-message" style="margin-left: 15px; padding-left: 0;">
                <h1><i class="fas fa-gamepad"></i>ä½ è¯´æˆ‘çŒœ</h1>
            </div>
        </div>

        <!-- å¯¹è¯åŒºåŸŸ -->
        <div class="chat-area">

            <div class="message-bubble">
                <div class="message-avatar">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=youngboyhappy" alt="å¼€å‘è€…å¤´åƒ">
                </div>
                <div class="message-content">
                    <p>æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨å‘¢~</p>
                </div>
            </div>

            <!-- ç©å®¶è¾“å…¥åŒºåŸŸ -->
            <div class="user-input-area">
<textarea id="userMessage" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜/å»ºè®®ï¼ˆå¦‚ï¼šæˆ‘æƒ³æ–°å¢ä¸€ä¸ªâ€œè”¬èœæ°´æœâ€ä¸»é¢˜çš„è¯åº“ï¼Œå·²å‘ç±³æ”¯æŒï¼Œè°¢è°¢~ï¼‰"
          rows="4"></textarea>
                <button id="sendEmailBtn" class="btn btn-primary"
                        style="float: right; width: auto; padding: 16px 30px;">
                    <i class="fas fa-paper-plane"></i> å‘é€
                </button>
                <div style="clear: both;"></div> <!-- æ¸…é™¤æµ®åŠ¨ -->
            </div>
        </div>

        <!-- ç‚¹èµæ”¯æŒåŒºåŸŸ -->
        <div class="donation-section">
            <h4><i class="fas fa-hand-holding-usd"></i> æ”¯æŒå¼€å‘è€…</h4>

        </div>
        <div class="qrcode-container">
            <div
                    style="width: 100%; background: #f8f9fa; padding: 8px; border-radius: 6px; box-sizing: border-box;">
                <div style="display: flex; flex-direction: column; width: 100%;">
                    <!-- ç¬¬ä¸€è¡Œ -->
                    <div style="display: flex; width: 100%; height: 120px; margin-bottom: 0;">
                        <!-- å›¾ç‰‡1 -->
                        <div style="flex: 1; overflow: hidden; margin-right: 0;">
                            <img src="https://raw.githubusercontent.com/fankaiming2/XPengGames/main/image/IMG_1397.JPG"
                                 style="width: 100%; height: 120px; object-fit: cover; display: block;" alt="æ¸¸æˆæˆªå›¾1">
                        </div>
                        <!-- å›¾ç‰‡2 -->
                        <div style="flex: 1; overflow: hidden;">
                            <img src="https://raw.githubusercontent.com/fankaiming2/XPengGames/main/image/IMG_1398.JPG"
                                 style="width: 100%; height: 120px; object-fit: cover; display: block;" alt="æ¸¸æˆæˆªå›¾2">
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œ -->
                    <div style="display: flex; width: 100%; height: 120px;">
                        <!-- å›¾ç‰‡3 -->
                        <div style="flex: 1; overflow: hidden; margin-right: 0;">
                            <img src="https://raw.githubusercontent.com/fankaiming2/XPengGames/main/image/IMG_1399.JPG"
                                 style="width: 100%; height: 120px; object-fit: cover; display: block;" alt="æ¸¸æˆæˆªå›¾3">
                        </div>
                        <!-- å›¾ç‰‡4 -->
                        <div style="flex: 1; overflow: hidden;">
                            <img src="https://raw.githubusercontent.com/fankaiming2/XPengGames/main/image/IMG_1400.JPG"
                                 style="width: 100%; height: 120px; object-fit: cover; display: block;" alt="æ¸¸æˆæˆªå›¾4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- å¼€å‘è€…ä¿¡æ¯ -->
        <div class="developer-info">

            <div class="developer-message" style="margin-left: 15px; padding-left: 0; margin-top: 15px;">
                <p class="developer-email">è”ç³»é‚®ç®±ï¼š<a href="mailto:ming95ming@126.com">ming95ming@126.com</a></p>
            </div>

        </div>
    </div>
</div>
<script>
    // ==================== æ–°å¢ï¼šé‡åŠ›æ„Ÿåº”çŠ¶æ€ç®¡ç† ====================
    const motionState = {
    hasPermission: false,
    isSupported: 'DeviceOrientationEvent' in window,
    isIos: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
    };

    // è¯·æ±‚é‡åŠ›æ„Ÿåº”æƒé™
    function requestMotionPermission() {
    if (!motionState.isSupported) {
    if (typeof callback === 'function') callback(false);
    return;
    }

    if (motionState.isIos) {
    // iOSéœ€è¦ç‰¹æ®Šæƒé™è¯·æ±‚
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
    .then(permissionState => {
    if (permissionState === 'granted') {
    motionState.hasPermission = true;
    showMotionStatus(true);
    startGestureListening();
    console.log('iOSé‡åŠ›æ„Ÿåº”æƒé™å·²æˆäºˆ');
    } else {
    showMotionStatus(false, 'æƒé™è¢«æ‹’ç»');
    }
    })
    .catch(error => {
    console.error('è¯·æ±‚æƒé™å¤±è´¥:', error);
    showMotionStatus(false, 'è¯·æ±‚å¤±è´¥');
    });
    } else {
    // iOS 13+ ä¹‹å‰ç‰ˆæœ¬
    motionState.hasPermission = true;
    startGestureListening();
    showMotionStatus(true);
    }
    } else {
    // Androidå’Œå…¶ä»–è®¾å¤‡é€šå¸¸ä¸éœ€è¦ç‰¹æ®Šæƒé™
    motionState.hasPermission = true;
    startGestureListening();
    showMotionStatus(true);
    }
    }

    // æ˜¾ç¤ºé‡åŠ›æ„Ÿåº”çŠ¶æ€
    function showMotionStatus(enabled, message = '') {
    const statusElement = document.getElementById('motionStatus');
    const requestBtn = document.getElementById('requestMotionBtn');

    if (enabled) {
    // statusElement.style.display = 'flex';
    // statusElement.innerHTML = `
    //     <i class="fas fa-check-circle" style="color: #2ed573; font-size: 1.5rem;"></i>
    //     // <div>
    //     //     <p style="font-weight: bold; color: #2ed573; margin: 0;">âœ“ é‡åŠ›æ„Ÿåº”å·²å¯ç”¨</p>
    //     //     <p style="font-size: 0.9rem; margin: 5px 0 0 0; color: #666;">ç°åœ¨å¯ä»¥ä½¿ç”¨æ‰‹æœºæ—‹è½¬æ§åˆ¶æ¸¸æˆ</p>
    //     // </div>
    // `;
    requestBtn.innerHTML = '<i class="fas fa-check-circle"></i> é‡åŠ›æ„Ÿåº”å·²å¯ç”¨';
    requestBtn.classList.remove('btn-info');
    requestBtn.classList.add('btn-success');
    } else {
    statusElement.style.display = 'flex';
    statusElement.innerHTML = `
                       <i class="fas fa-exclamation-circle" style="color: #ff4757; font-size: 1.5rem;"></i>
                       <div>
                           <p style="font-weight: bold; color: #ff4757; margin: 0;">âœ— é‡åŠ›æ„Ÿåº”æœªå¯ç”¨</p>
                           <p style="font-size: 0.9rem; margin: 5px 0 0 0; color: #666;">${message || 'è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯ç”¨'}</p>
                       </div>
                   `;
    requestBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> å¯ç”¨é‡åŠ›æ„Ÿåº”';
    requestBtn.classList.remove('btn-success');
    requestBtn.classList.add('btn-info');
    }
    }
    // ==================== é…ç½®åŒºåŸŸ ====================
    const CONFIG = {
    // ä¿®æ”¹å½•åˆ¶é…ç½®
                // ä¿®æ”¹å½•åˆ¶é…ç½® - é™ä½è´¨é‡å‡å°‘å¡é¡¿
    RECORDING: {
    enabled: true,
                    width: 1280,
                    height: 720,
                    frameRate: 30,
                    bitrate: 2500000,
                    width: 640,  // ä»1280é™ä½åˆ°640
                    height: 480, // ä»720é™ä½åˆ°480
                    frameRate: 15,  // ä»30é™ä½åˆ°15
                    bitrate: 1000000,  // ä»2500000é™ä½åˆ°1000000
    textStyle: {
                        fontSize: '72px',
                        fontSize: '48px',  // ä»72pxé™ä½åˆ°48px
    fontFamily: 'PingFang SC, sans-serif',
    fontWeight: 'bold',
    color: '#FFFFFF',
    textShadow: '2px 2px 8px #000000',
    textAlign: 'center',
    padding: '20px'
    },
    watermark: 'ä½ è¯´æˆ‘çŒœ'
    },
    // æ–°å¢ï¼šéŸ³æ•ˆé…ç½®
    AUDIO: {
    enabled: true,
    volume: 0.5,
    countdownBeepUrls: [
    "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ",
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„beepéŸ³æ•ˆ
    ],
    // å€’è®¡æ—¶èƒŒæ™¯éŸ³ä¹ï¼ˆç®€å•çš„åˆæˆéŸ³æ•ˆï¼‰
    countdownMusic: "data:audio/mpeg;base64,/+MYxAAAAANIAAAAAExBTUUzLjk4LjIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
    // æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
    gameStartSound: "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQCgAABkYXRhAKAAAGRhZGE="
    },
    defaultThemeIcon: 'fas fa-question-circle',
    defaultThemeColor: '#888',
    // ä¸»é¢˜é…ç½®æ–‡ä»¶æ˜ å°„ï¼ˆæ–‡ä»¶å -> æ˜¾ç¤ºåç§°ï¼‰
    themeFiles: {
    },

    // ä¸»é¢˜å›¾æ ‡æ˜ å°„
    themeIcons: {
    'æˆè¯­': 'fas fa-book-open',
    'å½±è§†å¨±ä¹': 'fas fa-film',
    'å…«é›¶ä¹é›¶': 'fas fa-history',           // æ€€æ—§ã€å¹´ä»£æ„Ÿ â†’ å†å²å›¾æ ‡
    'åƒå–ç©ä¹': 'fas fa-glass-cheers', // èšä¼šäº«ä¹ â†’ å¹²æ¯/åº†ç¥
    'æ ¡å›­': 'fas fa-graduation-cap', // æ•™è‚² â†’ å­¦å£«å¸½
    'ç§‘æŠ€': 'fas fa-microchip',         // ç§‘æŠ€ â†’ èŠ¯ç‰‡/ç¡¬ä»¶
    'ç”Ÿæ´»æ—¥å¸¸': 'fas fa-home',          // æ—¥å¸¸ç”Ÿæ´» â†’ æˆ¿å­
    'å…´è¶£çˆ±å¥½': 'fas fa-heart',         // å…´è¶£çˆ±å¥½ â†’ å¿ƒå½¢ï¼ˆçƒ­çˆ±ï¼‰
    'èŒåœº': 'fas fa-briefcase',         // èŒåœº â†’ å…¬æ–‡åŒ…
    'å†å²': 'fas fa-book'

    },

    // ä¸»é¢˜é¢œè‰²æ˜ å°„
    themeColors: {
    'æˆè¯­': '#2575fc',
    'å½±è§†å¨±ä¹': '#ff9f43',
    'å…«é›¶ä¹é›¶': '#ee5a24',
    'åƒå–ç©ä¹': '#2ed573',
    'æ ¡å›­': '#6c5ce7',
    'ç§‘æŠ€': '#00d2d3',
    'ç”Ÿæ´»æ—¥å¸¸': '#a55eea',           // ç´«è‰²ç³»ï¼Œæ€€æ—§æ„Ÿ
    'å…´è¶£çˆ±å¥½': '#fd79a8',           // ç²‰çº¢ç³»ï¼Œæ¬¢ä¹èšä¼š
    'å†å²': '#fdcb6e',           // æš–é»„è‰²ï¼Œæ¸©é¦¨å±…å®¶
    'èŒåœº': '#34495e'               // æ·±è“ç°ï¼Œå•†åŠ¡æ­£å¼æ„Ÿ
    },

    // é‡åŠ›æ„Ÿåº”é…ç½® - ä¿®æ”¹ä¸ºæ—‹è½¬æ£€æµ‹
    GESTURE: {
    MIN_ROTATION_ANGLE: 15,      // æœ€å°æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰- æ›´çµæ•
    MAX_ROTATION_ANGLE: 90,       // æœ€å¤§æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰- é¿å…è¿‡åº¦æ—‹è½¬
    ROTATION_SPEED_THRESHOLD: 45, // æœ€å°æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰- é™ä½è¦æ±‚
    COOLDOWN: 600,                // æ‰‹åŠ¿å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- ç¼©çŸ­
    DEBOUNCE_TIME: 200,           // é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    HISTORY_SIZE: 8               // å†å²è®°å½•å¤§å°
    },
    // æ—¶é—´é€‰é¡¹
    timeOptions: [1, 2, 3]
    };

    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    const gameState = {
    themes: [],              // ä»æ–‡ä»¶åŠ è½½çš„ä¸»é¢˜æ•°æ®
    currentTheme: null,
    selectedTime: 2,
    timer: null,
    timeLeft: 0,            // æ€»ç§’æ•°
    timeLeftMs: 0,          // æ¯«ç§’éƒ¨åˆ†
    currentWordIndex: 0,
    correctCount: 0,
    skippedCount: 0,
    totalWordsShown: 0,
    wordsForGame: [],
    lastGestureTime: 0,     // ä¸Šæ¬¡æ‰‹åŠ¿æ—¶é—´æˆ³
    lastAcceleration: { x: 0, y: 0, z: 0 }, // ä¸Šæ¬¡åŠ é€Ÿåº¦å€¼
    // æ–°å¢ï¼šè®°å½•æ¯ä¸ªè¯è¯­çš„çŠ¶æ€
    wordHistory: [], // æ ¼å¼: { word: "è¯è¯­", status: "correct"|"skipped", timestamp: æ—¶é—´æˆ³ }
    // æ–°å¢ï¼šå€’è®¡æ—¶ç›¸å…³
    countdownTimer: null,
    countdownValue: 5,
    // æ–°å¢ï¼šé‡åŠ›æ„Ÿåº”æ§åˆ¶æ ‡å¿—
    motionEnabled: false,   // æ¸¸æˆè¿‡ç¨‹ä¸­æ‰å¯ç”¨é‡åŠ›æ„Ÿåº”
    motionListener: null,    // ä¿å­˜äº‹ä»¶ç›‘å¬å™¨å¼•ç”¨ï¼Œä¾¿äºç§»é™¤
    // æ–°å¢ï¼šéŸ³æ•ˆç›¸å…³çŠ¶æ€
    audioEnabled: true,
    audioContext: null,
    audioBuffers: {},
    countdownAudio: null,
    isAudioLoading: false,
    // æ–°å¢ï¼šå½•åˆ¶ç›¸å…³çŠ¶æ€
    recordingEnabled: false,
    isRecording: false,
    recordingStartTime: 0,
    recordingTimer: null,
    mediaStream: null,
    mediaRecorder: null,
    recordedChunks: [],
    currentWordText: ''
    };


    // ç´§å¼ éŸ³æ•ˆçŠ¶æ€
    const tenseAudioState = {
    isPlaying: false,
    audioContext: null,
    oscillators: [],
    gainNode: null
    };
    // ==================== æ–°å¢ï¼šå½•åˆ¶åŠŸèƒ½ ====================

            // è¯·æ±‚æ‘„åƒå¤´æƒé™
    // è¯·æ±‚æ‘„åƒå¤´æƒé™
    async function requestCameraPermission() {
    try {
    const stream = await navigator.mediaDevices.getUserMedia({
    video: {
                            facingMode: 'user', // å‰ç½®æ‘„åƒå¤´
                            facingMode: 'user',
    width: { ideal: CONFIG.RECORDING.width },
                            height: { ideal: CONFIG.RECORDING.height }
                            height: { ideal: CONFIG.RECORDING.height },
                            frameRate: { ideal: CONFIG.RECORDING.frameRate }  // é™åˆ¶å¸§ç‡
    },
                        audio: true // å½•åˆ¶å£°éŸ³
                        audio: true
    });

    gameState.mediaStream = stream;

    // æ˜¾ç¤ºæ‘„åƒå¤´é¢„è§ˆ
    const videoElement = document.getElementById('cameraVideo');
    videoElement.srcObject = stream;

    // æ˜¾ç¤ºå½•åˆ¶ç•Œé¢
    document.getElementById('cameraPreview').style.display = 'block';

    return true;
    } catch (error) {
    console.error('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»:', error);
    return false;
    }
    }

    // ==================== ä¿®æ”¹ï¼šå½•åˆ¶åŠŸèƒ½ ====================

    // ä¿®æ”¹ startRecording å‡½æ•°
    async function startRecording() {
    // ç°åœ¨ä¸éœ€è¦è¯·æ±‚æƒé™ï¼Œå› ä¸ºå·²ç»åœ¨è¿›å…¥æ¸¸æˆæ—¶è¯·æ±‚äº†
    if (!gameState.mediaStream) {
    console.log('æ²¡æœ‰æ‘„åƒå¤´æƒé™ï¼Œè·³è¿‡å½•åˆ¶');
    return;
    }
    try {
    // åˆ›å»ºCanvasç”¨äºå åŠ æ–‡å­—
    const canvas = document.createElement('canvas');
    canvas.width = CONFIG.RECORDING.width;
    canvas.height = CONFIG.RECORDING.height;
    const ctx = canvas.getContext('2d');

    // åˆ›å»ºCanvasæµ
    const canvasStream = canvas.captureStream(30); // 30 FPS

    // åˆå¹¶éŸ³é¢‘æµï¼ˆä»æ‘„åƒå¤´è·å–ï¼‰
    const audioTrack = gameState.mediaStream.getAudioTracks()[0];
    const combinedStream = new MediaStream();

    // æ·»åŠ éŸ³é¢‘è½¨é“
    if (audioTrack) {
    combinedStream.addTrack(audioTrack);
    }

    // æ·»åŠ Canvasè§†é¢‘è½¨é“
    const canvasVideoTrack = canvasStream.getVideoTracks()[0];
    if (canvasVideoTrack) {
    combinedStream.addTrack(canvasVideoTrack);
    }

    // æ£€æµ‹è®¾å¤‡å¹¶é€‰æ‹©æ ¼å¼
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    let mimeType = 'video/webm;codecs=vp8,opus';

    if (isIOS || isSafari) {
    // iOS/Safariä½¿ç”¨H.264
    mimeType = 'video/mp4;codecs=avc1.42E01E,mp4a.40.2';
    }

    console.log('ä½¿ç”¨MIMEç±»å‹:', mimeType);

    // æ£€æŸ¥æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼
    if (!MediaRecorder.isTypeSupported(mimeType)) {
    console.warn('é¦–é€‰æ ¼å¼ä¸æ”¯æŒï¼Œå°è¯•å…¶ä»–æ ¼å¼');
    // å°è¯•å…¶ä»–æ ¼å¼
    const formats = [
    'video/mp4',
    'video/webm',
    'video/webm;codecs=vp9,opus',
    'video/webm;codecs=vp8'
    ];

    for (const format of formats) {
    if (MediaRecorder.isTypeSupported(format)) {
    mimeType = format;
    console.log('ä½¿ç”¨å¤‡ç”¨æ ¼å¼:', format);
    break;
    }
    }
    }

    // åˆ›å»ºMediaRecorder
    const options = {
    mimeType: mimeType,
    videoBitsPerSecond: CONFIG.RECORDING.bitrate,
    audioBitsPerSecond: 128000
    };

    gameState.mediaRecorder = new MediaRecorder(combinedStream, options);
    gameState.recordedChunks = [];

    // ç›‘å¬æ•°æ®
    gameState.mediaRecorder.ondataavailable = (event) => {
    if (event.data.size > 0) {
    gameState.recordedChunks.push(event.data);
    }
    };

    // ç›‘å¬å½•åˆ¶åœæ­¢
    gameState.mediaRecorder.onstop = saveRecording;

    // å¼€å§‹å½•åˆ¶
    gameState.mediaRecorder.start(1000); // æ¯ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®

    // æ›´æ–°çŠ¶æ€
    gameState.isRecording = true;
    gameState.recordingStartTime = Date.now();

    // æ˜¾ç¤ºå½•åˆ¶æŒ‡ç¤ºå™¨
    document.getElementById('recordingIndicator').style.display = 'flex';

    // å¼€å§‹è®¡æ—¶å™¨
    startRecordingTimer();

    // åˆæˆè§†é¢‘å¸§ - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
    const videoElement = document.getElementById('cameraVideo');

    // ç¡®ä¿è§†é¢‘å·²åŠ è½½
    videoElement.onloadedmetadata = () => {
    console.log('è§†é¢‘å·²åŠ è½½ï¼Œå¼€å§‹åˆæˆ');
    };

    // ä¿®æ”¹åçš„ç»˜åˆ¶å‡½æ•°
                    function drawFrame() {
                        if (!gameState.isRecording || !ctx) return;

                        try {
                            // æ¸…é™¤ç”»å¸ƒ
                            ctx.fillStyle = '#000';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // ç»˜åˆ¶è§†é¢‘å¸§
                            if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                                // è®¡ç®—è§†é¢‘å®½é«˜æ¯”å¹¶å±…ä¸­ç»˜åˆ¶
                                const videoAspect = videoElement.videoWidth / videoElement.videoHeight;
                                const canvasAspect = canvas.width / canvas.height;

                                let renderWidth, renderHeight, offsetX, offsetY;

                                if (videoAspect > canvasAspect) {
                                    // è§†é¢‘æ›´å®½
                                    renderHeight = canvas.height;
                                    renderWidth = videoElement.videoWidth * (canvas.height / videoElement.videoHeight);
                                    offsetX = -(renderWidth - canvas.width) / 2;
                                    offsetY = 0;
                                } else {
                                    // è§†é¢‘æ›´é«˜
                                    renderWidth = canvas.width;
                                    renderHeight = videoElement.videoHeight * (canvas.width / videoElement.videoWidth);
                                    offsetX = 0;
                                    offsetY = -(renderHeight - canvas.height) / 2;
                                }

                                // =============== æ–°å¢ï¼šç¾é¢œæ»¤é•œå¤„ç† ===============
                                // åˆ›å»ºç¦»å±Canvasç”¨äºæ»¤é•œå¤„ç†
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = renderWidth;
                                tempCanvas.height = renderHeight;
                                const tempCtx = tempCanvas.getContext('2d');

                                // 1. å…ˆç»˜åˆ¶åŸå§‹è§†é¢‘å¸§åˆ°ç¦»å±Canvas
                                tempCtx.drawImage(videoElement, 0, 0, renderWidth, renderHeight);
                    // ä¿®æ”¹åçš„ç»˜åˆ¶å‡½æ•°
                function drawFrame() {
                    if (!gameState.isRecording || !ctx) return;

                    try {
                        // æ¸…é™¤ç”»å¸ƒ
                        ctx.fillStyle = '#000';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // ç»˜åˆ¶è§†é¢‘å¸§ - ç®€åŒ–è®¡ç®—
                        if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                            // ç®€å•å±…ä¸­ç»˜åˆ¶ï¼Œä¸è®¡ç®—å®½é«˜æ¯”
                            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        }

                                // 2. åº”ç”¨ç¾é¢œæ»¤é•œ
                                applyBeautyFilter(tempCtx, renderWidth, renderHeight);
                        // ç»˜åˆ¶å½“å‰è¯è¯­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (gameState.currentWordText) {
                            // è®¾ç½®æ–‡å­—æ ·å¼
                            ctx.font = `bold ${CONFIG.RECORDING.textStyle.fontSize} ${CONFIG.RECORDING.textStyle.fontFamily}`;
                            ctx.fillStyle = CONFIG.RECORDING.textStyle.color;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';

                            // æ·»åŠ æ–‡å­—é˜´å½±
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;
                            ctx.shadowBlur = 8;

                            // è®¡ç®—æ–‡å­—ä½ç½®ï¼ˆå±…ä¸­åä¸‹ï¼‰
                            const x = canvas.width / 2;
                            const y = canvas.height - 80;  // æé«˜ä½ç½®ï¼Œé¿å…æ¨¡ç³Šåçœ‹ä¸æ¸…

                            // ç»˜åˆ¶æ–‡å­—èƒŒæ™¯ï¼ˆå¯é€‰ï¼Œå¢åŠ å¯è¯»æ€§ï¼‰
                            const textWidth = ctx.measureText(gameState.currentWordText).width;
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                            ctx.fillRect(x - textWidth / 2 - 15, y - 30, textWidth + 30, 60);

                            // ç»˜åˆ¶æ–‡å­—
                            ctx.fillStyle = CONFIG.RECORDING.textStyle.color;
                            ctx.fillText(gameState.currentWordText, x, y);

                            // é‡ç½®é˜´å½±
                            ctx.shadowColor = 'transparent';
                            ctx.shadowOffsetX = 0;
                            ctx.shadowOffsetY = 0;
                            ctx.shadowBlur = 0;

                            // ç»˜åˆ¶æ°´å°ï¼ˆç®€åŒ–ï¼‰
                            ctx.font = `16px ${CONFIG.RECORDING.textStyle.fontFamily}`;
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.textAlign = 'left';
                            ctx.fillText(CONFIG.RECORDING.watermark, 10, 30);
                        }

                                // 3. å°†å¤„ç†åçš„å›¾åƒç»˜åˆ¶åˆ°ä¸»Canvas
                                ctx.drawImage(videoElement, offsetX, offsetY, renderWidth, renderHeight);
                        // é™ä½ç»˜åˆ¶é¢‘ç‡ï¼Œä»60fpsé™åˆ°30fps
                        setTimeout(() => {
                            if (gameState.isRecording) {
                                requestAnimationFrame(drawFrame);
    }
                        }, 33); // çº¦30fps

                            // ç»˜åˆ¶å½“å‰è¯è¯­
                            if (gameState.currentWordText) {
                                // è®¾ç½®æ–‡å­—æ ·å¼
                                ctx.font = `bold ${CONFIG.RECORDING.textStyle.fontSize} ${CONFIG.RECORDING.textStyle.fontFamily}`;
                                ctx.fillStyle = CONFIG.RECORDING.textStyle.color;
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';

                                // æ·»åŠ æ–‡å­—é˜´å½±
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                                ctx.shadowOffsetX = 2;
                                ctx.shadowOffsetY = 2;
                                ctx.shadowBlur = 8;

                                // è®¡ç®—æ–‡å­—ä½ç½®ï¼ˆå±…ä¸­åä¸‹ï¼‰
                                const x = canvas.width / 2;
                                const y = canvas.height - 120;  // æ”¹è¿™é‡Œï¼šä» -100 æ”¹ä¸º -120ï¼Œç»™å¤§å­—ä½“æ›´å¤šç©ºé—´

                                // ç»˜åˆ¶æ–‡å­—èƒŒæ™¯ï¼ˆå¯é€‰ï¼Œå¢åŠ å¯è¯»æ€§ï¼‰
                                const textWidth = ctx.measureText(gameState.currentWordText).width;
                                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                                ctx.fillRect(x - textWidth / 2 - 25, y - 40, textWidth + 50, 80);  // æ”¹è¿™é‡Œï¼šå¢åŠ èƒŒæ™¯åŒºåŸŸ

                                // ç»˜åˆ¶æ–‡å­—
                                ctx.fillStyle = CONFIG.RECORDING.textStyle.color;
                                ctx.fillText(gameState.currentWordText, x, y);

                                // é‡ç½®é˜´å½±
                                ctx.shadowColor = 'transparent';
                                ctx.shadowOffsetX = 0;
                                ctx.shadowOffsetY = 0;
                                ctx.shadowBlur = 0;

                                // ç»˜åˆ¶æ°´å°
                                ctx.font = `20px ${CONFIG.RECORDING.textStyle.fontFamily}`;
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                                ctx.textAlign = 'left';
                                ctx.fillText(CONFIG.RECORDING.watermark, 20, 40);
                    } catch (error) {
                        console.error('ç»˜åˆ¶å¸§æ—¶å‡ºé”™:', error);
                        // ç»§ç»­å°è¯•ç»˜åˆ¶
                        setTimeout(() => {
                            if (gameState.isRecording) {
                                requestAnimationFrame(drawFrame);
    }

                            // ç»§ç»­ä¸‹ä¸€å¸§
                            requestAnimationFrame(drawFrame);

                        } catch (error) {
                            console.error('ç»˜åˆ¶å¸§æ—¶å‡ºé”™:', error);
                            // ç»§ç»­å°è¯•ç»˜åˆ¶
                            requestAnimationFrame(drawFrame);
                        }
                        }, 100);
    }
                }

    // å¼€å§‹ç»˜åˆ¶
    videoElement.play().then(() => {
    console.log('è§†é¢‘å¼€å§‹æ’­æ”¾ï¼Œå¼€å§‹ç»˜åˆ¶');
    drawFrame();
    }).catch(error => {
    console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
    });

    console.log('å½•åˆ¶å·²å¼€å§‹');

    } catch (error) {
    console.error('å¼€å§‹å½•åˆ¶å¤±è´¥:', error);
    alert('å½•åˆ¶åŠŸèƒ½å‡ºé”™: ' + error.message);
    }
    }
    // =============== æ–°å¢ï¼šç¾é¢œæ»¤é•œå‡½æ•° ===============
            // =============== ä¿®æ”¹ï¼šç¾é¢œæ»¤é•œå‡½æ•° ===============
    function applyBeautyFilter(ctx, width, height) {
    // è·å–å›¾åƒæ•°æ®
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;

                // è½»åº¦ç¾é¢œå‚æ•°ï¼ˆå¯è°ƒèŠ‚ï¼‰
                const beautyParams = {
                    smoothness: 0.7,      // å¹³æ»‘åº¦ (0-1)
                    brightness: 0.15,     // äº®åº¦å¢å¼º (0-0.2)
                    contrast: 1.05,       // å¯¹æ¯”åº¦å¢å¼º (1-1.2)
                    redAdjust: 1.02,      // çº¢è‰²å¢å¼ºï¼ˆæ°”è‰²ï¼‰
                    saturation: 1.08      // é¥±å’Œåº¦å¢å¼º
                };

                // 1. å…ˆè¿›è¡Œè½»åº¦æ¨¡ç³Šï¼ˆå¹³æ»‘çš®è‚¤ï¼‰
                applyMildBlur(data, width, height, beautyParams.smoothness);

                // 2. è°ƒæ•´é¢œè‰²ï¼ˆç¾ç™½ã€æ°”è‰²ï¼‰
                for (let i = 0; i < data.length; i += 4) {
                    // è·å–åŸå§‹é¢œè‰²
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];

                    // å¢åŠ äº®åº¦
                    r = Math.min(255, r * (1 + beautyParams.brightness));
                    g = Math.min(255, g * (1 + beautyParams.brightness));
                    b = Math.min(255, b * (1 + beautyParams.brightness));
                // åªä¿ç•™è½»åº¦æ¨¡ç³Šï¼Œç§»é™¤é¢œè‰²è°ƒæ•´
                const smoothness = 0.3;  // é™ä½æ¨¡ç³Šå¼ºåº¦ï¼ˆä»0.7é™åˆ°0.3ï¼‰

                    // è°ƒæ•´å¯¹æ¯”åº¦
                    const avg = (r + g + b) / 3;
                    r = avg + (r - avg) * beautyParams.contrast;
                    g = avg + (g - avg) * beautyParams.contrast;
                    b = avg + (b - avg) * beautyParams.contrast;

                    // å¢å¼ºçº¢è‰²ï¼ˆå¥½æ°”è‰²ï¼‰
                    r = Math.min(255, r * beautyParams.redAdjust);

                    // å¢åŠ é¥±å’Œåº¦
                    const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                    r = gray + (r - gray) * beautyParams.saturation;
                    g = gray + (g - gray) * beautyParams.saturation;
                    b = gray + (b - gray) * beautyParams.saturation;

                    // è®¾ç½®æ–°çš„é¢œè‰²å€¼
                    data[i] = Math.max(0, Math.min(255, r));
                    data[i + 1] = Math.max(0, Math.min(255, g));
                    data[i + 2] = Math.max(0, Math.min(255, b));
                }
                // åº”ç”¨è½»åº¦æ¨¡ç³Š
                applyMildBlur(data, width, height, smoothness);

    // 3. åº”ç”¨ä¿®æ”¹åçš„å›¾åƒæ•°æ®
    ctx.putImageData(imageData, 0, 0);
    }
    // =============== æ–°å¢ï¼šè½»åº¦æ¨¡ç³Šå‡½æ•° ===============
            // =============== ä¿®æ”¹ï¼šè½»åº¦æ¨¡ç³Šå‡½æ•° ===============
    function applyMildBlur(data, width, height, strength) {
                // ç®€å•çš„é«˜æ–¯æ¨¡ç³Šæ•ˆæœï¼ˆè½»åº¦ï¼‰
                const radius = Math.floor(strength *5); // æ¨¡ç³ŠåŠå¾„
                if (radius <= 0) return;
                // å¦‚æœä¸éœ€è¦æ¨¡ç³Šï¼Œç›´æ¥è¿”å›
                if (strength <= 0) return;

                // ç®€å•å¿«é€Ÿæ¨¡ç³Šï¼šå‡å°‘é‡‡æ ·åŠå¾„
                const radius = Math.floor(strength * 3); // ä»5é™ä½åˆ°3

    // åˆ›å»ºä¸´æ—¶æ•°ç»„å­˜å‚¨æ¨¡ç³Šåçš„æ•°æ®
    const tempData = new Uint8ClampedArray(data.length);

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                // ç®€åŒ–æ¨¡ç³Šç®—æ³•ï¼Œå‡å°‘å¾ªç¯æ¬¡æ•°
                for (let y = 0; y < height; y += 2) {  // éš”è¡Œå¤„ç†
                    for (let x = 0; x < width; x += 2) {  // éš”åˆ—å¤„ç†
                        // ç®€åŒ–é‡‡æ ·
    let r = 0, g = 0, b = 0, count = 0;

                        // å¯¹å‘¨å›´åƒç´ å–æ ·
                        for (let dy = -radius; dy <= radius; dy++) {
                            for (let dx = -radius; dx <= radius; dx++) {
                        for (let dy = -radius; dy <= radius; dy += 2) {  // å‡å°‘é‡‡æ ·ç‚¹
                            for (let dx = -radius; dx <= radius; dx += 2) {
    const nx = x + dx;
    const ny = y + dy;

    if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
    const index = (ny * width + nx) * 4;
    r += data[index];
    g += data[index + 1];
    b += data[index + 2];
    count++;
    }
    }
    }

                        // è®¡ç®—å¹³å‡å€¼
    const index = (y * width + x) * 4;
                        tempData[index] = r / count;
                        tempData[index + 1] = g / count;
                        tempData[index + 2] = b / count;
                        tempData[index + 3] = data[index + 3]; // ä¿æŒAlphaä¸å˜
                        if (count > 0) {
                            tempData[index] = r / count;
                            tempData[index + 1] = g / count;
                            tempData[index + 2] = b / count;
                            tempData[index + 3] = data[index + 3];
                        }
    }
    }

                // å°†æ¨¡ç³Šåçš„æ•°æ®æ··åˆå›åŸæ•°æ®ï¼ˆéƒ¨åˆ†æ··åˆï¼Œä¿æŒç»†èŠ‚ï¼‰
                const mixRatio = 0.6; // æ··åˆæ¯”ä¾‹ï¼Œå€¼è¶Šå°è¶Šè‡ªç„¶
                // ç®€åŒ–æ··åˆï¼šåªæ··åˆæ¨¡ç³ŠåŒºåŸŸ
                const mixRatio = 0.4; // é™ä½æ··åˆæ¯”ä¾‹ï¼ˆä»0.6é™åˆ°0.4ï¼‰
    for (let i = 0; i < data.length; i += 4) {
    data[i] = data[i] * (1 - mixRatio) + tempData[i] * mixRatio;
    data[i + 1] = data[i + 1] * (1 - mixRatio) + tempData[i + 1] * mixRatio;
    data[i + 2] = data[i + 2] * (1 - mixRatio) + tempData[i + 2] * mixRatio;
    }
    }
    // ä¿®æ”¹ updateCurrentWordText å‡½æ•°ï¼Œç¡®ä¿æ–‡å­—æ›´æ–°
    function updateCurrentWordText(word) {
    gameState.currentWordText = word;
    console.log('æ›´æ–°å½“å‰è¯è¯­æ–‡æœ¬:', word);
    }

    // åœ¨ showNextWord å‡½æ•°ä¸­ç¡®ä¿è°ƒç”¨æ›´æ–°
    function showNextWord() {
    if (gameState.currentWordIndex >= gameState.wordsForGame.length) {
    shuffleArray(gameState.wordsForGame);
    gameState.currentWordIndex = 0;
    }

    const word = gameState.wordsForGame[gameState.currentWordIndex];
    elements.currentWord.textContent = word;
    gameState.totalWordsShown++;
    updateGameStats();
    gameState.currentWordIndex++;

    // æ–°å¢ï¼šæ›´æ–°å½•åˆ¶ä¸­çš„æ–‡å­—
    updateCurrentWordText(word);

    console.log('æ˜¾ç¤ºæ–°è¯è¯­:', word);
    }

    // ä¿®æ”¹ saveRecording å‡½æ•°ï¼Œæ·»åŠ æ›´å¥½çš„é”™è¯¯å¤„ç†
    function saveRecording() {
    if (gameState.recordedChunks.length === 0) {
    console.log('æ²¡æœ‰å½•åˆ¶æ•°æ®');
    alert('å½•åˆ¶å¤±è´¥ï¼šæ²¡æœ‰å½•åˆ¶åˆ°æ•°æ®');
    return;
    }

    try {
    // ç¡®å®šæ–‡ä»¶ç±»å‹
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    let blobType, fileExtension;

    if (isIOS || isSafari) {
    blobType = 'video/mp4';
    fileExtension = 'mp4';
    } else {
    // æ£€æŸ¥ç¬¬ä¸€ä¸ªchunkçš„ç±»å‹
    const firstChunk = gameState.recordedChunks[0];
    if (firstChunk.type.includes('webm')) {
    blobType = 'video/webm';
    fileExtension = 'webm';
    } else if (firstChunk.type.includes('mp4')) {
    blobType = 'video/mp4';
    fileExtension = 'mp4';
    } else {
    blobType = firstChunk.type;
    fileExtension = 'mp4';
    }
    }

    console.log('ä¿å­˜æ–‡ä»¶ç±»å‹:', blobType, 'æ‰©å±•å:', fileExtension);

    // åˆå¹¶æ•°æ®
    const blob = new Blob(gameState.recordedChunks, { type: blobType });

    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;

    // ç”Ÿæˆæ–‡ä»¶å
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    a.download = `ä½ è¯´æˆ‘çŒœ_${gameState.currentTheme.name}_${timestamp}.${fileExtension}`;

    // è§¦å‘ä¸‹è½½
    document.body.appendChild(a);
    a.click();

    // æ¸…ç†
    setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    console.log('è§†é¢‘å·²ä¿å­˜');

    // æ˜¾ç¤ºä¿å­˜æç¤º
    setTimeout(() => {
    alert(`è§†é¢‘å·²ä¿å­˜ä¸º ${fileExtension.toUpperCase()} æ ¼å¼æ–‡ä»¶ï¼\n\næ–‡ä»¶åï¼š${a.download}\n\nè¯·æŸ¥çœ‹æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚`);
    }, 500);
    }, 100);

    } catch (error) {
    console.error('ä¿å­˜è§†é¢‘å¤±è´¥:', error);
    alert('ä¿å­˜è§†é¢‘å¤±è´¥ï¼š' + error.message + '\n\nè¯·å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚Chromeï¼‰æˆ–æ£€æŸ¥å­˜å‚¨æƒé™ã€‚');
    }
    }

    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    console.log('å½•åˆ¶åŠŸèƒ½å·²åŠ è½½');
    console.log('MediaRecorderæ”¯æŒ:', !!window.MediaRecorder);
    console.log('æ”¯æŒçš„MIMEç±»å‹æµ‹è¯•:');
    ['video/webm', 'video/mp4', 'video/webm;codecs=vp8', 'video/webm;codecs=vp9'].forEach(type => {
    console.log(`${type}: ${MediaRecorder.isTypeSupported(type)}`);
    });
    // å¼€å§‹å½•åˆ¶è®¡æ—¶å™¨
    function startRecordingTimer() {
    clearInterval(gameState.recordingTimer);

    gameState.recordingTimer = setInterval(() => {
    const elapsed = Date.now() - gameState.recordingStartTime;
    const seconds = Math.floor(elapsed / 1000);
    const minutes = Math.floor(seconds / 60);

    const timeStr = `${minutes.toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
    document.getElementById('recordingTime').textContent = timeStr;
    }, 1000);
    }

    // åœæ­¢å½•åˆ¶
    function stopRecording() {
    if (!gameState.isRecording || !gameState.mediaRecorder) return;

    gameState.mediaRecorder.stop();
    gameState.isRecording = false;

    // éšè—æŒ‡ç¤ºå™¨
    document.getElementById('recordingIndicator').style.display = 'none';

    // åœæ­¢è®¡æ—¶å™¨
    clearInterval(gameState.recordingTimer);

    // åœæ­¢æ‘„åƒå¤´é¢„è§ˆ
    if (gameState.mediaStream) {
    gameState.mediaStream.getTracks().forEach(track => track.stop());
    document.getElementById('cameraPreview').style.display = 'none';
    }

    console.log('å½•åˆ¶å·²åœæ­¢');
    }

    // ä¿å­˜å½•åˆ¶æ–‡ä»¶
    // ä¿®æ”¹ saveRecording å‡½æ•°
    function saveRecording() {
    if (gameState.recordedChunks.length === 0) {
    console.log('æ²¡æœ‰å½•åˆ¶æ•°æ®');
    return;
    }

    try {
    // æ£€æµ‹iOSè®¾å¤‡
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    let blobType, fileExtension;

    if (isIOS) {
    // iOSè®¾å¤‡ä½¿ç”¨MP4æ ¼å¼
    blobType = 'video/mp4';
    fileExtension = 'mp4';
    } else {
    // å…¶ä»–è®¾å¤‡ä½¿ç”¨WebM
    blobType = 'video/webm';
    fileExtension = 'webm';
    }

    // åˆå¹¶æ•°æ®
    const blob = new Blob(gameState.recordedChunks, { type: blobType });

    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;

    // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ ¹æ®æ ¼å¼ä½¿ç”¨æ­£ç¡®çš„æ‰©å±•åï¼‰
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    a.download = `ä½ è¯´æˆ‘çŒœ_${gameState.currentTheme.name}_${timestamp}.${fileExtension}`;

    // è§¦å‘ä¸‹è½½
    document.body.appendChild(a);
    a.click();

    // æ¸…ç†
    setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    }, 100);

    console.log(`è§†é¢‘å·²ä¿å­˜ä¸º${fileExtension}æ ¼å¼`);

    // åœ¨iOSä¸Šæ˜¾ç¤ºé¢å¤–æç¤º
    if (isIOS) {
    setTimeout(() => {
    alert('è§†é¢‘å·²ä¿å­˜ä¸ºMP4æ ¼å¼ã€‚\nè¯·å‰å¾€"æ–‡ä»¶"åº”ç”¨æˆ–"ç…§ç‰‡"åº”ç”¨æŸ¥çœ‹ä¸‹è½½çš„è§†é¢‘ã€‚');
    }, 500);
    }

    } catch (error) {
    console.error('ä¿å­˜è§†é¢‘å¤±è´¥:', error);

    // æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    let errorMsg = 'ä¿å­˜è§†é¢‘å¤±è´¥: ' + error.message;
    if (error.name === 'NotSupportedError') {
    errorMsg += '\n\næ‚¨çš„è®¾å¤‡å¯èƒ½ä¸æ”¯æŒè§†é¢‘å½•åˆ¶åŠŸèƒ½ã€‚';
    }
    alert(errorMsg);
    }
    }


    // æ›´æ–°å½“å‰è¯è¯­æ–‡æœ¬ï¼ˆç”¨äºå åŠ åˆ°è§†é¢‘ï¼‰
    function updateCurrentWordText(word) {
    gameState.currentWordText = word;
    }



    // åˆå§‹åŒ–ç´§å¼ éŸ³æ•ˆ
    function initTenseAudio() {
    if (!window.AudioContext && !window.webkitAudioContext) return;

    try {
    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
    tenseAudioState.audioContext = new AudioContextClass();
    } catch (error) {
    console.log('åˆå§‹åŒ–ç´§å¼ éŸ³æ•ˆå¤±è´¥:', error);
    }
    }
    // ==================== ä¿®æ”¹ï¼šç´§å¼ éŸ³æ•ˆé…ç½® ====================
    const TENSE_AUDIO_CONFIG = {
    minInterval: 1000, // åˆå§‹é—´éš”ï¼š1ç§’
    maxInterval: 200,  // æœ€å°é—´éš”ï¼š0.2ç§’
    volume: 0.4,       // å›ºå®šéŸ³é‡ï¼ˆ40%ï¼‰
    baseFreq: 800,     // åŸºç¡€é¢‘ç‡
    maxFreq: 1200,     // æœ€é«˜é¢‘ç‡
    minDuration: 0.1,  // æœ€çŸ­æŒç»­æ—¶é—´
    maxDuration: 0.2   // æœ€é•¿æŒç»­æ—¶é—´
    };

    // ==================== ä¿®æ”¹ï¼šæ’­æ”¾å€’è®¡æ—¶ç´§å¼ éŸ³æ•ˆ ====================
    function playCountdownTenseSound(remainingTime) {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();

    // è®¡ç®—ç´§å¼ åº¦ (10ç§’ -> 0ç§’ï¼Œç´§å¼ åº¦ä»0åˆ°1)
    const tension = 1 - (remainingTime / 10000);

    // æ ¹æ®ç´§å¼ åº¦è®¡ç®—å‚æ•°
    const frequency = TENSE_AUDIO_CONFIG.baseFreq +
    (TENSE_AUDIO_CONFIG.maxFreq - TENSE_AUDIO_CONFIG.baseFreq) * tension;

    const duration = TENSE_AUDIO_CONFIG.minDuration +
    (TENSE_AUDIO_CONFIG.maxDuration - TENSE_AUDIO_CONFIG.minDuration) * (1 - tension);

    // åˆ›å»ºä¸¤ä¸ªæŒ¯è¡å™¨åˆ¶é€ ç”µå­è¡¨æ»´ç­”å£°
    const oscillator1 = context.createOscillator();
    const oscillator2 = context.createOscillator();
    const gainNode = context.createGain();

    oscillator1.connect(gainNode);
    oscillator2.connect(gainNode);
    gainNode.connect(context.destination);

    // è®¾ç½®é¢‘ç‡ï¼šéšç€ç´§å¼ åº¦å¢åŠ ï¼Œé¢‘ç‡å‡é«˜
    oscillator1.frequency.value = frequency;
    oscillator2.frequency.value = frequency * 1.2; // ç¬¬äºŒä¸ªæŒ¯è¡å™¨ç¨é«˜

    // ä½¿ç”¨ä¸‰è§’æ³¢ï¼Œå£°éŸ³æ›´æŸ”å’Œ
    oscillator1.type = 'triangle';
    oscillator2.type = 'triangle';

    const now = context.currentTime;

    // å›ºå®šéŸ³é‡ï¼Œä¸æ¸å¼º
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(TENSE_AUDIO_CONFIG.volume, now + 0.002); // å¿«é€Ÿèµ·éŸ³
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration); // å¿«é€Ÿè¡°å‡

    oscillator1.start(now);
    oscillator2.start(now);
    oscillator1.stop(now + duration);
    oscillator2.stop(now + duration);

    } catch (error) {
    console.log('æ’­æ”¾å€’è®¡æ—¶ç´§å¼ éŸ³æ•ˆå¤±è´¥:', error);
    }
    }
    function playTenseBackgroundSound(volumeMultiplier = 1, speedMultiplier = 0) {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();

    // æ ¹æ®ç´§å¼ ç¨‹åº¦é€‰æ‹©æ’­æ”¾å“ªç§éŸ³æ•ˆ
    if (volumeMultiplier > 0.7) {
    // æœ€å3ç§’ä½¿ç”¨æ›´æ€¥ä¿ƒçš„éŸ³æ•ˆ
    playIntenseTicking(context, volumeMultiplier, speedMultiplier);
    } else {
    // å‰7ç§’ä½¿ç”¨æ¸å¼ºéŸ³æ•ˆ
    playClockBeep(context, volumeMultiplier);
    }

    } catch (error) {
    console.log('æ’­æ”¾ç´§å¼ éŸ³æ•ˆå¤±è´¥:', error);
    }
    }

    function playClockBeep(context, volumeMultiplier = 1) {
    try {
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    const now = context.currentTime;

    // é—¹é’Ÿæ¸…è„†å£° - æœ€åå‡ ç§’é¢‘ç‡æ›´é«˜æ›´æ€¥ä¿ƒ
    // æ—¶é—´è¶Šå°‘ï¼Œé¢‘ç‡è¶Šé«˜ï¼ˆä»1000Hzåˆ°1500Hzï¼‰
    const baseFreq = 1000 + (volumeMultiplier * 500);
    oscillator.frequency.value = baseFreq;
    oscillator.type = 'square'; // æ–¹æ³¢æœ‰ç”µå­æ„Ÿ

    // éå¸¸çŸ­ä¿ƒ - æœ€åå‡ ç§’æ›´æ€¥ä¿ƒ
    const duration = 0.15 - (volumeMultiplier * 0.05); // ä»150msç¼©çŸ­åˆ°100ms

    gainNode.gain.setValueAtTime(0, now);
    // åº”ç”¨æ¸å¼ºéŸ³é‡ï¼šCONFIG.AUDIO.volume * 0.6 * volumeMultiplier
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.6 * volumeMultiplier, now + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);

    oscillator.start();
    oscillator.stop(now + duration);

    } catch (error) {
    console.log('æ’­æ”¾é—¹é’Ÿå£°å¤±è´¥:', error);
    }
    }
    // æ–°å¢ï¼šæ’­æ”¾æ¸å¼ºæ€¥ä¿ƒéŸ³æ•ˆ
    function playIntenseTicking(context, volumeMultiplier, speedMultiplier) {
    try {
    const oscillator1 = context.createOscillator();
    const oscillator2 = context.createOscillator();
    const gainNode = context.createGain();

    oscillator1.connect(gainNode);
    oscillator2.connect(gainNode);
    gainNode.connect(context.destination);

    const now = context.currentTime;

    // é¢‘ç‡éšç´§å¼ åº¦æé«˜è€Œå¢åŠ 
    const baseFreq = 800 + (volumeMultiplier * 700); // ä»800Hzåˆ°1500Hz

    oscillator1.frequency.value = baseFreq;
    oscillator2.frequency.value = baseFreq * 1.5; // åˆ¶é€ ç´§è¿«æ„Ÿ

    oscillator1.type = 'square';
    oscillator2.type = 'square'; // ä¸¤ä¸ªæ–¹æ³¢åˆ¶é€ æ›´åˆºè€³çš„æ•ˆæœ

    // æŒç»­æ—¶é—´éšé€Ÿåº¦åŠ å¿«è€Œç¼©çŸ­
    const duration = 0.12 - (speedMultiplier * 0.08); // ä»120msç¼©çŸ­åˆ°40ms

    // æ›´å°–é”çš„èµ·éŸ³
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.8 * volumeMultiplier, now + 0.005);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);

    oscillator1.start();
    oscillator2.start();

    oscillator1.stop(now + duration);
    oscillator2.stop(now + duration);

    } catch (error) {
    console.log('æ’­æ”¾æ€¥ä¿ƒéŸ³æ•ˆå¤±è´¥:', error);
    }
    }
    // ==================== ä¿®æ”¹ï¼šåœæ­¢ç´§å¼ éŸ³æ•ˆ ====================
    function stopTenseBackgroundSound() {
    // è¿™é‡Œä¸»è¦æ˜¯é‡ç½®çŠ¶æ€ï¼ŒéŸ³æ•ˆæœ¬èº«æ˜¯çŸ­æš‚æ’­æ”¾çš„ï¼Œä¼šè‡ªåŠ¨åœæ­¢
    // æˆ‘ä»¬åªéœ€è¦ç¡®ä¿æ²¡æœ‰æŒç»­çš„éŸ³é¢‘ä¸Šä¸‹æ–‡é—®é¢˜
    try {
    if (gameState.audioContext && gameState.audioContext.state !== 'closed') {
    // å¦‚æœæœ‰éœ€è¦å¯ä»¥åœ¨è¿™é‡Œåœæ­¢æ‰€æœ‰éŸ³æº
    }
    } catch (error) {
    console.log('åœæ­¢éŸ³æ•ˆæ—¶å‡ºé”™:', error);
    }
    }

    // ==================== DOMå…ƒç´  ====================
    const elements = {
    themeGrid: document.getElementById('themeGrid'),
    timeOptions: document.getElementById('timeOptions'),
    currentTheme: document.getElementById('currentTheme'),
    currentWord: document.getElementById('currentWord'),
    timer: document.getElementById('timer'),
    timerMs: document.getElementById('timerMs'),
    correctCount: document.getElementById('correctCount'),
    skippedCount: document.getElementById('skippedCount'),
    // finalScore: document.getElementById('finalScore'),
    finalCorrect: document.getElementById('finalCorrect'),
    finalSkipped: document.getElementById('finalSkipped'),
    resultMessage: document.getElementById('resultMessage'),
    loader: document.getElementById('loader'),
    // æ–°å¢ï¼šå›é¡¾ç›¸å…³å…ƒç´ 
    reviewContent: document.getElementById('reviewContent'),
    wordReviewList: document.getElementById('wordReviewList'),
    reviewCorrectCount: document.getElementById('reviewCorrectCount'),
    reviewSkippedCount: document.getElementById('reviewSkippedCount'),
    toggleReview: document.getElementById('toggleReview'),
    // showReviewBtn: document.getElementById('showReviewBtn'),
    // æ–°å¢ï¼šå€’è®¡æ—¶å…ƒç´ 
    countdownOverlay: document.getElementById('countdownOverlay'),
    countdownNumber: document.getElementById('countdownNumber'),
    // æ–°å¢ï¼šå‡†å¤‡ç•Œé¢å…ƒç´ 
    readySection: document.getElementById('readySection'),
    readyTheme: document.getElementById('readyTheme'),
    readyTime: document.getElementById('readyTime'),
    startNowBtn: document.getElementById('startNowBtn'),
    cancelStartBtn: document.getElementById('cancelStartBtn')
    };

    // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
    // è·å–ç›®å½•ä¸­çš„txtæ–‡ä»¶åˆ—è¡¨
    async function getThemeFiles() {
    try {
    // å°è¯•åŠ è½½ç´¢å¼•æ–‡ä»¶
    const response = await fetch('words/index.txt');
    if (response.ok) {
    const text = await response.text();
    const files = text.split('\n')
    .map(line => line.trim())
    .filter(line => line && line.endsWith('.txt'));
    console.log('ä»ç´¢å¼•æ–‡ä»¶è·å–çš„ä¸»é¢˜:', files);
    return files;
    }

    // å¦‚æœç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨
    console.log('ç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨');
    return [
    'æˆè¯­.txt',
    'åäººæ˜æ˜Ÿ.txt',
    'ç¾é£Ÿ.txt',
    'è¿åŠ¨.txt',
    'ç”µå½±.txt',
    'åŠ¨ç‰©.txt',
    'æ°´æœ.txt'  // æ·»åŠ æ°´æœ
    ];
    } catch (error) {
    console.error('è·å–ä¸»é¢˜æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    // è¿”å›åŒ…å«æ‰€æœ‰å¯èƒ½æ–‡ä»¶çš„åˆ—è¡¨
    return [
    'æˆè¯­.txt',
    'åäººæ˜æ˜Ÿ.txt',
    'ç¾é£Ÿ.txt',
    'è¿åŠ¨.txt',
    'ç”µå½±.txt',
    'åŠ¨ç‰©.txt',
    'æ°´æœ.txt'
    ];
    }
    }

    // 1. ä»TXTæ–‡ä»¶åŠ è½½è¯è¯­åº“
    async function loadWordFile(filename) {
    try {
    const response = await fetch(`words/${filename}`);
    if (!response.ok) throw new Error(`æ— æ³•åŠ è½½æ–‡ä»¶: ${filename}`);

    const text = await response.text();
    const words = text.split('\n')
    .map(line => line.trim())
    .filter(line => line && !line.startsWith('#') && !line.startsWith('//'));

    console.log(`åŠ è½½ä¸»é¢˜ ${filename}: ${words.length} ä¸ªè¯è¯­`);
    return words;
    } catch (error) {
    console.error('åŠ è½½è¯è¯­æ–‡ä»¶å¤±è´¥:', error);
    return getDefaultWords(filename);
    }
    }
    // 3. ä»æ–‡ä»¶åæå–ä¸»é¢˜åç§°
    function extractThemeName(filename) {
    // ç§»é™¤.txtæ‰©å±•å
    const nameWithoutExt = filename.replace('.txt', '');

    // å¤„ç†å¯èƒ½çš„ä¸‹åˆ’çº¿æˆ–è¿å­—ç¬¦
    return nameWithoutExt.replace(/[_-]/g, ' ');
    }
    // 4. è·å–ä¸»é¢˜å›¾æ ‡
    function getThemeIcon(themeName) {
    return CONFIG.themeIcons[themeName] || CONFIG.defaultThemeIcon;
    }
    // 5. è·å–ä¸»é¢˜é¢œè‰²
    function getThemeColor(themeName) {
    return CONFIG.themeColors[themeName] || CONFIG.defaultThemeColor;
    }



    // 6. åˆå§‹åŒ–æ‰€æœ‰ä¸»é¢˜
    async function initAllThemes() {
    showLoader(true);
    gameState.themes = [];

    try {
    // è·å–ç›®å½•ä¸­çš„txtæ–‡ä»¶åˆ—è¡¨
    const themeFiles = await getThemeFiles();
    console.log('æ‰¾åˆ°çš„ä¸»é¢˜æ–‡ä»¶:', themeFiles);

    // åŠ è½½æ¯ä¸ªä¸»é¢˜
    for (const filename of themeFiles) {
    const words = await loadWordFile(filename);
    if (words.length > 0) {
    const themeName = extractThemeName(filename);

    gameState.themes.push({
    id: filename.replace('.txt', ''),
    name: themeName,
    icon: getThemeIcon(themeName),
    color: getThemeColor(themeName),
    words: words
    });

    console.log(`æ·»åŠ ä¸»é¢˜: ${themeName} (${words.length}ä¸ªè¯è¯­)`);
    }
    }
    // åŠ è½½è‡ªå®šä¹‰è¯åº“ï¼ˆä»sessionStorageï¼‰
    loadCustomThemes();
    // å¦‚æœæ²¡åŠ è½½åˆ°ä»»ä½•ä¸»é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
    if (gameState.themes.length === 0) {
    console.log('ä½¿ç”¨é»˜è®¤ä¸»é¢˜æ•°æ®');
    gameState.themes = getDefaultThemes();
    }
    } catch (error) {
    console.error('åˆå§‹åŒ–ä¸»é¢˜æ—¶å‡ºé”™:', error);
    // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤ä¸»é¢˜
    gameState.themes = getDefaultThemes();
    }

    initThemeSelection();
    showLoader(false);
    console.log(`æˆåŠŸåŠ è½½ ${gameState.themes.length} ä¸ªä¸»é¢˜`);
    }
    // åŠ è½½è‡ªå®šä¹‰è¯åº“
    function loadCustomThemes() {
    try {
    const customThemes = sessionStorage.getItem('custom_themes');
    if (customThemes) {
    const themes = JSON.parse(customThemes);
    themes.forEach(theme => {
    // ä¸ºè‡ªå®šä¹‰ä¸»é¢˜ç”Ÿæˆå”¯ä¸€çš„ID
    const themeId = `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    gameState.themes.push({
    id: themeId,
    name: theme.name,
    icon: theme.icon,
    color: '#ff9f43', // è‡ªå®šä¹‰ä¸»é¢˜ä½¿ç”¨æ©™è‰²
    words: theme.words,
    isCustom: true, // æ ‡è®°ä¸ºè‡ªå®šä¹‰ä¸»é¢˜
    createdAt: theme.createdAt
    });

    console.log(`æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜: ${theme.name} (${theme.words.length}ä¸ªè¯è¯­)`);
    });
    }
    } catch (error) {
    console.error('åŠ è½½è‡ªå®šä¹‰ä¸»é¢˜æ—¶å‡ºé”™:', error);
    }
    }
    // 3. åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©ç•Œé¢
    function initThemeSelection() {
    elements.themeGrid.innerHTML = '';
    gameState.themes.forEach(theme => {
    const themeCard = document.createElement('div');
    themeCard.className = 'theme-card';
    themeCard.dataset.id = theme.id;
    themeCard.innerHTML = `
                   <i class="${theme.icon} theme-icon" style="color:${theme.color}"></i>
                   <div class="theme-name">${theme.name}</div>
               `;
    themeCard.addEventListener('click', () => selectTheme(theme.id));
    elements.themeGrid.appendChild(themeCard);
    });

    // ==================== æ–°å¢ï¼šæ·»åŠ "æ›´å¤š"å¡ç‰‡ ====================
    const moreCard = document.createElement('div');
    moreCard.className = 'theme-card';
    moreCard.dataset.id = 'more';
    moreCard.style.cursor = 'pointer';
    moreCard.innerHTML = `
               <i class="fas fa-plus theme-icon" style="color:#6a11cb"></i>
               <div class="theme-name">æ›´å¤š</div>
           `;

    // ç‚¹å‡»"æ›´å¤š"å¡ç‰‡æ—¶è§¦å‘åº•éƒ¨åé¦ˆå…¥å£
    moreCard.addEventListener('click', () => {
    // è§¦å‘åº•éƒ¨åé¦ˆå…¥å£çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('feedbackTrigger').click();

    // å¯é€‰ï¼šæ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
    moreCard.style.transform = 'scale(0.95)';
    setTimeout(() => {
    moreCard.style.transform = 'scale(1)';
    }, 200);
    });

    // å°†"æ›´å¤š"å¡ç‰‡æ·»åŠ åˆ°ç½‘æ ¼ä¸­
    elements.themeGrid.appendChild(moreCard);
    // ==================== æ–°å¢ä»£ç ç»“æŸ ====================

    // åˆå§‹åŒ–æ—¶é—´é€‰é¡¹
    initTimeOptions();

    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¸»é¢˜
    if (gameState.themes.length > 0) {
    selectTheme(gameState.themes[0].id);
    }
    }

    function initTimeOptions() {
    elements.timeOptions.innerHTML = '';
    CONFIG.timeOptions.forEach(time => {
    const timeOption = document.createElement('div');
    timeOption.className = `time-option ${time === 2 ? 'selected' : ''}`;
    timeOption.textContent = `${time}åˆ†é’Ÿ`;
    timeOption.dataset.time = time;
    timeOption.addEventListener('click', () => selectTime(time));
    elements.timeOptions.appendChild(timeOption);
    });
    }

    function selectTheme(themeId) {
    document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.remove('selected');
    });

    const selectedCard = document.querySelector(`.theme-card[data-id="${themeId}"]`);
    if (selectedCard) selectedCard.classList.add('selected');

    gameState.currentTheme = gameState.themes.find(t => t.id === themeId);
    }

    function selectTime(time) {
    document.querySelectorAll('.time-option').forEach(option => {
    option.classList.remove('selected');
    });

    const selectedOption = document.querySelector(`.time-option[data-time="${time}"]`);
    if (selectedOption) selectedOption.classList.add('selected');

    gameState.selectedTime = time;
    }

    // 4. å¼€å§‹æ¸¸æˆ - ä¿®æ”¹ä¸ºè¿›å…¥å‡†å¤‡ç•Œé¢
    function startGame() {
    if (!gameState.currentTheme) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼');
    return;
    }
    // è‡ªåŠ¨è¯·æ±‚é‡åŠ›æ„Ÿåº”æƒé™ï¼ˆå¦‚æœæœªå¯ç”¨ï¼‰
    if (!motionState.hasPermission && motionState.isSupported) {
    console.log('è‡ªåŠ¨è¯·æ±‚é‡åŠ›æ„Ÿåº”æƒé™...');
    requestMotionPermission();
    }

    // æ–°å¢ï¼šå‰ç½®è¯·æ±‚æ‘„åƒå¤´æƒé™
    if (gameState.recordingEnabled && CONFIG.RECORDING.enabled) {
    console.log('å‰ç½®è¯·æ±‚æ‘„åƒå¤´æƒé™...');
    requestCameraPermission().then(granted => {
    if (granted) {
    console.log('æ‘„åƒå¤´æƒé™å·²è·å–ï¼Œè¿›å…¥å‡†å¤‡ç•Œé¢');
    // æ›´æ–°å‡†å¤‡ç•Œé¢ä¿¡æ¯
    elements.readyTheme.textContent = gameState.currentTheme.name;
    elements.readyTime.textContent = gameState.selectedTime;

    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // æ˜¾ç¤ºå‡†å¤‡ç•Œé¢
    showSection('ready');
    } else {
    console.log('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»');
    // ç”¨æˆ·æ‹’ç»å½•åˆ¶ï¼Œä½†ä»ç„¶å¯ä»¥ç»§ç»­æ¸¸æˆ
    gameState.recordingEnabled = false;

    // æ›´æ–°å‡†å¤‡ç•Œé¢ä¿¡æ¯
    elements.readyTheme.textContent = gameState.currentTheme.name;
    elements.readyTime.textContent = gameState.selectedTime;

    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // æ˜¾ç¤ºå‡†å¤‡ç•Œé¢
    showSection('ready');
    }
    }).catch(error => {
    console.error('è¯·æ±‚æ‘„åƒå¤´æƒé™å¤±è´¥:', error);
    // å‡ºé”™æ—¶ç¦ç”¨å½•åˆ¶åŠŸèƒ½ï¼Œç»§ç»­æ¸¸æˆ
    gameState.recordingEnabled = false;

    // æ›´æ–°å‡†å¤‡ç•Œé¢ä¿¡æ¯
    elements.readyTheme.textContent = gameState.currentTheme.name;
    elements.readyTime.textContent = gameState.selectedTime;

    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // æ˜¾ç¤ºå‡†å¤‡ç•Œé¢
    showSection('ready');
    });
    } else {
    // ä¸å¯ç”¨å½•åˆ¶åŠŸèƒ½ï¼Œç›´æ¥è¿›å…¥å‡†å¤‡ç•Œé¢
    console.log('å½•åˆ¶åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥è¿›å…¥å‡†å¤‡ç•Œé¢');

    // æ›´æ–°å‡†å¤‡ç•Œé¢ä¿¡æ¯
    elements.readyTheme.textContent = gameState.currentTheme.name;
    elements.readyTime.textContent = gameState.selectedTime;

    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // æ˜¾ç¤ºå‡†å¤‡ç•Œé¢
    showSection('ready');
    }
    }

    // 5. ç«‹å³å¼€å§‹æ¸¸æˆï¼ˆä»å‡†å¤‡ç•Œé¢ï¼‰
    // ä¿®æ”¹åçš„ startGameNow å‡½æ•°ï¼ˆä»å‡†å¤‡ç•Œé¢å¼€å§‹ï¼‰
    function startGameNow() {
    // æ£€æŸ¥é‡åŠ›æ„Ÿåº”çŠ¶æ€ï¼Œä½†ä¸å†å¼¹å‡ºç¡®è®¤æ¡†
    if (!motionState.hasPermission && motionState.isSupported) {
    console.log('é‡åŠ›æ„Ÿåº”æœªå¯ç”¨ï¼Œå°†ä»…ä½¿ç”¨æŒ‰é’®æ“ä½œ');
    }

    // é‡ç½®æ¸¸æˆçŠ¶æ€
    resetGameState();
    // ç¡®ä¿é‡åŠ›æ„Ÿåº”æ˜¯ç¦ç”¨çŠ¶æ€ï¼ˆå€’è®¡æ—¶æœŸé—´ï¼‰
    disableGameMotion();

    // å‡†å¤‡è¯è¯­
    gameState.wordsForGame = [...gameState.currentTheme.words];
    shuffleArray(gameState.wordsForGame);

    // æ›´æ–°UI
    elements.currentTheme.textContent = gameState.currentTheme.name + 'çŒœçŒœçŒœ';
    // // å¼€å§‹å€’è®¡æ—¶
    startCountdown();
    }

    // 6. å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
    // ç¡®ä¿é‡åŠ›æ„Ÿåº”æ˜¯ç¦ç”¨çŠ¶æ€
    disableGameMotion();
    // é‡ç½®å€’è®¡æ—¶å€¼
    gameState.countdownValue = 5;
    elements.countdownNumber.textContent = gameState.countdownValue;
    elements.countdownOverlay.style.display = 'flex';
    // æ’­æ”¾å€’è®¡æ—¶éŸ³æ•ˆ
    playCountdownBeep(gameState.countdownValue);
    playCountdownMusic();
    gameState.countdownTimer = setInterval(() => {
    gameState.countdownValue--;

    if (gameState.countdownValue > 0) {
    elements.countdownNumber.textContent = gameState.countdownValue;
    // æ’­æ”¾å€’è®¡æ—¶æ•°å­—éŸ³æ•ˆ
    playCountdownBeep(gameState.countdownValue);
    // æ·»åŠ éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    if (navigator.vibrate) {
    navigator.vibrate(100);
    }
    } else {
    // å€’è®¡æ—¶ç»“æŸæ—¶ç›´æ¥éšè—è¦†ç›–å±‚å¹¶å¼€å§‹æ¸¸æˆ
    clearInterval(gameState.countdownTimer);
    elements.countdownOverlay.style.display = 'none';
    // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
    playGameStartSound();
    // ç›´æ¥å¼€å§‹æ¸¸æˆï¼Œæ²¡æœ‰é¢å¤–å»¶è¿Ÿ
    startActualGame();
    }
    }, 1000);
    }

    // 7. å®é™…å¼€å§‹æ¸¸æˆé€»è¾‘
    function startActualGame() {
    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
    showSection('game');
    // å†æ¬¡æ£€æŸ¥é‡åŠ›æ„Ÿåº”çŠ¶æ€
    if (!motionState.hasPermission && motionState.isSupported) {
    console.log('æ¸¸æˆå¼€å§‹ï¼Œä½†é‡åŠ›æ„Ÿåº”æœªå¯ç”¨ï¼Œä»…ä½¿ç”¨æŒ‰é’®æ“ä½œ');
    }
    // å¦‚æœå¯ç”¨äº†å½•åˆ¶ï¼Œå¼€å§‹å½•åˆ¶
    if (gameState.recordingEnabled) {
    setTimeout(() => {
    startRecording();
    }, 500); // å»¶è¿Ÿ500mså¼€å§‹å½•åˆ¶
    }
    // å¼€å§‹è®¡æ—¶å™¨
    startTimer();

    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªè¯è¯­
    showNextWord();

    // åˆå§‹åŒ–æ‰‹åŠ¿æ£€æµ‹
    initGestureDetection();
    enableGameMotion(); // æ–°å¢ï¼šå¯ç”¨æ¸¸æˆè¿‡ç¨‹ä¸­çš„é‡åŠ›æ„Ÿåº”

    }

    // 8. é‡ç½®æ¸¸æˆçŠ¶æ€
    function resetGameState() {
    gameState.currentWordIndex = 0;
    gameState.correctCount = 0;
    gameState.skippedCount = 0;
    gameState.totalWordsShown = 0;
    gameState.timeLeft = gameState.selectedTime * 60;
    gameState.timeLeftMs = 0;
    gameState.wordHistory = []; // æ¸…ç©ºå†å²è®°å½•
    gameState.lastGestureTime = 0; // é‡ç½®æ‰‹åŠ¿æ—¶é—´
    gameState.motionEnabled = false; // æ–°å¢ï¼šé‡ç½®ä¸ºç¦ç”¨çŠ¶æ€

    // åœæ­¢ç´§å¼ éŸ³æ•ˆ
    stopTenseBackgroundSound();
    // é‡ç½®UI
    elements.correctCount.textContent = '0';
    elements.skippedCount.textContent = '0';
    elements.timer.classList.remove('timer-low');

    resetBaselineAngle(); // é‡ç½®åŸºå‡†è§’åº¦
    }

    // ==================== ä¿®æ”¹ï¼šè®¡æ—¶å™¨æ›´æ–°é€»è¾‘ ====================
    // åœ¨ startTimer å‡½æ•°ä¸­ä¿®æ”¹æœ€å10ç§’çš„å¤„ç†é€»è¾‘

    function startTimer() {
    clearInterval(gameState.timer);

    // æ–°å¢ï¼šæœ€å10ç§’éŸ³æ•ˆç›¸å…³çŠ¶æ€
    let lastBeepTime = 0;
    let beepInterval = TENSE_AUDIO_CONFIG.minInterval;

    // é‡ç½®UIçŠ¶æ€
    elements.timer.classList.remove('timer-low');

    // è®¾ç½®åˆå§‹æ˜¾ç¤º
    const minutes = Math.floor(gameState.timeLeft / 60);
    const seconds = gameState.timeLeft % 60;
    const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    elements.timer.innerHTML = `${timerText}<span class="timer-ms" id="timerMs">.000</span>`;

    const startTime = Date.now();
    const totalMs = gameState.timeLeft * 1000;

    gameState.timer = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const remaining = Math.max(0, totalMs - elapsed);

    gameState.timeLeft = Math.floor(remaining / 1000);
    gameState.timeLeftMs = remaining % 1000;

    updateTimerDisplay();

    // ==================== ä¿®æ”¹ï¼šæœ€å10ç§’éŸ³æ•ˆé€»è¾‘ ====================
    if (remaining <= 10000 && remaining > 0) { // æœ€å10ç§’
    const currentTime = Date.now();

    // è®¡ç®—ç´§å¼ åº¦ (10ç§’ -> 0ç§’ï¼Œç´§å¼ åº¦ä»0åˆ°1)
    const tension = 1 - (remaining / 10000);

    // è®¡ç®—å½“å‰åº”è¯¥çš„æ»´ç­”é—´éš”ï¼šè¶Šç´§å¼ é—´éš”è¶ŠçŸ­
    beepInterval = TENSE_AUDIO_CONFIG.minInterval -
    (TENSE_AUDIO_CONFIG.minInterval - TENSE_AUDIO_CONFIG.maxInterval) * tension;

    // æ¯éš” beepInterval æ¯«ç§’æ’­æ”¾ä¸€æ¬¡æ»´ç­”å£°
    if (currentTime - lastBeepTime >= beepInterval) {
    playCountdownTenseSound(remaining);
    lastBeepTime = currentTime;

    // æ·»åŠ éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    if (navigator.vibrate) {
    const vibrationDuration = Math.max(30, 100 - (tension * 80));
    navigator.vibrate(vibrationDuration);
    }
    }

    // æ·»åŠ è§†è§‰åé¦ˆï¼ˆä¸ä¾èµ–ç´§å¼ åº¦ï¼‰
    if (!elements.timer.classList.contains('timer-low')) {
    elements.timer.classList.add('timer-low');
    }

    // è°ƒæ•´é—ªçƒé€Ÿåº¦ï¼šè¶Šç´§å¼ é—ªçƒè¶Šå¿«
    const pulseSpeed = 1 + (tension * 2); // ä»1ç§’åˆ°3ç§’ä¸€æ¬¡é—ªçƒ
    elements.timer.style.animation = `pulse ${1 / pulseSpeed}s infinite`;
    }

    // å½“è®¡æ—¶å™¨ç»“æŸæ—¶
    if (remaining <= 0) {
    // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
    stopTenseBackgroundSound();
    endGame();
    }
    }, 16); // çº¦60fps
    }

    // ä¿®æ”¹updateTimerDisplayå‡½æ•°
    function updateTimerDisplay() {
    const minutes = Math.floor(gameState.timeLeft / 60);
    const seconds = gameState.timeLeft % 60;

    // æ›´æ–°ä¸»è®¡æ—¶å™¨
    const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    elements.timer.innerHTML = `${timerText}<span class="timer-ms" id="timerMs">.${gameState.timeLeftMs.toString().padStart(3, '0')}</span>`;

    // ä½æ—¶é—´æé†’ï¼ˆ10ç§’ä»¥ä¸‹ï¼‰
    if (gameState.timeLeft < 10) {
    elements.timer.classList.add('timer-low');
    elements.timer.style.animation = 'pulse 0.5s infinite';
    } else {
    elements.timer.classList.remove('timer-low');
    elements.timer.style.animation = '';
    }
    }

    // 9. æ¸¸æˆæ§åˆ¶åŠŸèƒ½
    function showNextWord() {
    if (gameState.currentWordIndex >= gameState.wordsForGame.length) {
    shuffleArray(gameState.wordsForGame);
    gameState.currentWordIndex = 0;
    }

    const word = gameState.wordsForGame[gameState.currentWordIndex];
    elements.currentWord.textContent = word;
    gameState.totalWordsShown++;
    updateGameStats();
    gameState.currentWordIndex++;
    // æ–°å¢ï¼šæ›´æ–°å½•åˆ¶ä¸­çš„æ–‡å­—
    updateCurrentWordText(word);
    }

    function updateGameStats() {
    elements.correctCount.textContent = gameState.correctCount;
    elements.skippedCount.textContent = gameState.skippedCount;
    }

    // 10. å¢å¼ºmarkCorrectå’ŒskipWordçš„åé¦ˆ - ä¿®æ”¹ä¸ºè®°å½•å†å²
    function markCorrect() {
    const currentWord = elements.currentWord.textContent;
    // è®°å½•åˆ°å†å²
    gameState.wordHistory.push({
    word: currentWord,
    status: 'correct',
    timestamp: Date.now()
    });

    gameState.correctCount++;
    // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
    playGestureSound(true);
    showNextWord();

    // æ·»åŠ é¢å¤–åé¦ˆ
    elements.currentWord.style.animation = 'none';
    setTimeout(() => {
    elements.currentWord.style.animation = 'pulse 0.5s ease';
    }, 10);
    }

    function skipWord() {
    const currentWord = elements.currentWord.textContent;
    // è®°å½•åˆ°å†å²
    gameState.wordHistory.push({
    word: currentWord,
    status: 'skipped',
    timestamp: Date.now()
    });

    gameState.skippedCount++;
    // æ’­æ”¾è·³è¿‡éŸ³æ•ˆ
    playGestureSound(false);
    showNextWord();

    // æ·»åŠ é¢å¤–åé¦ˆ
    elements.currentWord.style.animation = 'none';
    setTimeout(() => {
    elements.currentWord.style.animation = 'shake 0.5s ease';
    }, 10);
    }

    // 11. æ¸¸æˆç»“æŸ - ä¿®æ”¹ä¸ºåŒ…å«å›é¡¾åŠŸèƒ½
    function endGame() {
    clearInterval(gameState.timer);
    // åœæ­¢æ‰€æœ‰éŸ³æ•ˆå’Œéœ‡åŠ¨
    stopTenseBackgroundSound();
    if (navigator.vibrate) {
    navigator.vibrate(0); // åœæ­¢éœ‡åŠ¨
    }
    // åœæ­¢å½•åˆ¶
    if (gameState.isRecording) {
    stopRecording();
    }

    // é‡ç½®UIçŠ¶æ€
    elements.timer.classList.remove('timer-low');
    elements.timer.style.animation = '';
    // ç¦ç”¨é‡åŠ›æ„Ÿåº”
    disableGameMotion();
    // é‡ç½®é‡åŠ›æ„Ÿåº”åŸºå‡†è§’åº¦
    resetBaselineAngle();
    const score = gameState.correctCount * 1;
    // elements.finalScore.textContent = score;
    elements.finalCorrect.textContent = gameState.correctCount;
    elements.finalSkipped.textContent = gameState.skippedCount;

    let message = '';
    if (score >= 80) message = 'å¤ªå‰å®³äº†ï¼ä½ æ˜¯çŒœè¯å¤§å¸ˆï¼';
    else if (score >= 50) message = 'ä¸é”™å“¦ï¼ç»§ç»­åŠªåŠ›ï¼';
    else if (score >= 30) message = 'ç»§ç»­åŠ æ²¹ï¼Œä¸‹æ¬¡ä¼šæ›´å¥½ï¼';
    else message = 'å¤šç©å‡ æ¬¡ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼';

    elements.resultMessage.textContent = message;
    // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
    playGameEndSound(score);

    // åˆå§‹åŒ–å›é¡¾å†…å®¹
    initWordReview();

    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });

    showSection('result');
    }

    // ==================== æ–°å¢ï¼šè¯è¯­å›é¡¾åŠŸèƒ½ ====================

    function initWordReview() {
    // æ¸…ç©ºä¹‹å‰çš„å›é¡¾å†…å®¹
    elements.wordReviewList.innerHTML = '';

    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    elements.reviewCorrectCount.textContent = gameState.correctCount;
    elements.reviewSkippedCount.textContent = gameState.skippedCount;

    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
    if (gameState.wordHistory.length === 0) {
    elements.wordReviewList.innerHTML = `
                   <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                       <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i>
                       <p>æš‚æ— è¯è¯­å›é¡¾è®°å½•</p>
                   </div>
               `;
    return;
    }

    // æ˜¾ç¤ºæ‰€æœ‰å†å²è¯è¯­
    gameState.wordHistory.forEach((item, index) => {
    const wordItem = document.createElement('div');
    wordItem.className = `word-item ${item.status}`;
    wordItem.innerHTML = `
                   <div>${item.word}</div>
                   <div class="word-status">${item.status === 'correct' ? 'âœ“' : 'â†’'}</div>
               `;
    elements.wordReviewList.appendChild(wordItem);
    });

    // ç›´æ¥æ“ä½œDOMï¼Œä¸ä¾èµ– toggleReview å‡½æ•°
    setTimeout(() => {
    elements.reviewContent.classList.add('expanded');
    elements.toggleReview.innerHTML = '<i class="fas fa-chevron-up"></i> æ”¶èµ·åˆ—è¡¨';
    elements.toggleReview.style.background = '#2575fc';
    elements.toggleReview.style.color = 'white';
    }, 10); // å¾®å°å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
    }

    function toggleReview(forceExpand = false) {
    const isExpanded = elements.reviewContent.classList.contains('expanded') || forceExpand;

    if (!isExpanded) {
    elements.reviewContent.classList.add('expanded');
    elements.toggleReview.innerHTML = '<i class="fas fa-chevron-up"></i> æ”¶èµ·åˆ—è¡¨';
    elements.toggleReview.style.background = '#2575fc';
    elements.toggleReview.style.color = 'white';
    } else {
    elements.reviewContent.classList.remove('expanded');
    elements.toggleReview.innerHTML = '<i class="fas fa-chevron-down"></i> å±•å¼€æŸ¥çœ‹';
    elements.toggleReview.style.background = '#f0f7ff';
    elements.toggleReview.style.color = '#2575fc';
    }
    }

    function showReview() {
    // ç¡®ä¿å›é¡¾åŒºåŸŸå±•å¼€
    toggleReview(true);

    // æ»šåŠ¨åˆ°å›é¡¾åŒºåŸŸ
    elements.reviewContent.scrollIntoView({
    behavior: 'smooth',
    block: 'start'
    });
    }

    // ==================== æ‰‹åŠ¿æ£€æµ‹ç›¸å…³åŠŸèƒ½ ====================

    // 12. æ·»åŠ é‡ç½®åŸºå‡†è§’åº¦çš„åŠŸèƒ½
    function resetBaselineAngle() {
    console.log('é‡ç½®åŸºå‡†è§’åº¦');
    baselineAlpha = null;
    }

    // 13. åˆå§‹åŒ–æ—¶æä¾›æ ¡å‡†æç¤º

    // ä¿®æ”¹initGestureDetectionå‡½æ•°
    function initGestureDetection() {
    if (!window.DeviceOrientationEvent) {
    console.log('è®¾å¤‡ä¸æ”¯æŒæ–¹å‘ä¼ æ„Ÿå™¨');
    return;
    }

    if (!motionState.hasPermission) {
    console.log('é‡åŠ›æ„Ÿåº”æƒé™æœªæˆäºˆ');
    return;
    }

    startGestureListening();
    }


    function showCalibrationHint() {
    const hint = document.createElement('div');
    hint.style.cssText = `
               position: fixed;
               top: 50%;
               left: 50%;
               transform: translate(-50%, -50%);
               background: white;
               border-radius: 15px;
               padding: 5px;
               box-shadow: 0 10px 30px rgba(0,0,0,0.2);
               z-index: 9998;
               animation: fadeIn 0.3s ease;
           `;

    document.body.appendChild(hint);

    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
    hint.style.opacity = '0';
    hint.style.transition = 'opacity 0.3s ease';
    setTimeout(() => hint.remove(), 300);
    }, 3000);
    }

    // æ‰‹åŠ¿æ£€æµ‹å‡½æ•°
    // æ‰‹åŠ¿æ£€æµ‹å‡½æ•°
    function startGestureListening() {
    if (!window.DeviceOrientationEvent) {
    console.log('è®¾å¤‡ä¸æ”¯æŒæ–¹å‘ä¼ æ„Ÿå™¨');
    return;
    }

    if (!motionState.hasPermission) {
    console.log('é‡åŠ›æ„Ÿåº”æƒé™æœªæˆäºˆ');
    return;
    }

    // å¦‚æœå·²ç»æœ‰ç›‘å¬å™¨ï¼Œå…ˆç§»é™¤
    if (gameState.motionListener) {
    window.removeEventListener('deviceorientation', gameState.motionListener);
    gameState.motionListener = null;
    }

    let rotationHistory = [];
    let lastValidTime = 0;
    let baselineAlpha = null;
    let isCalibrated = false;
    let calibrationSamples = [];

    // ä¿å­˜ç›‘å¬å™¨å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ç§»é™¤
    gameState.motionListener = (event) => {
    // æ£€æŸ¥é‡åŠ›æ„Ÿåº”æ˜¯å¦å¯ç”¨
    if (!gameState.motionEnabled) {
    return;
    }

    const currentTime = Date.now();
    const currentAlpha = event.alpha;

    // 1. æ ¡å‡†é˜¶æ®µ
    if (!isCalibrated) {
    calibrationSamples.push(currentAlpha);

    if (calibrationSamples.length >= 20) {
    const sum = calibrationSamples.reduce((a, b) => a + b, 0);
    baselineAlpha = sum / calibrationSamples.length;
    isCalibrated = true;
    console.log('æ ¡å‡†å®Œæˆï¼ŒåŸºå‡†è§’åº¦:', baselineAlpha);
    }
    return;
    }

    // 2. é˜²æŠ–å¤„ç†
    if (currentTime - lastValidTime < CONFIG.GESTURE.DEBUNCE_TIME) {
    return;
    }

    // 3. è®¡ç®—ç›¸å¯¹äºåŸºå‡†çš„è§’åº¦
    let relativeAngle = currentAlpha - baselineAlpha;
    if (relativeAngle > 180) relativeAngle -= 360;
    if (relativeAngle < -180) relativeAngle += 360;

    // 4. ä¿å­˜åˆ°å†å²è®°å½•
    rotationHistory.push({
    time: currentTime,
    angle: relativeAngle
    });

    if (rotationHistory.length > CONFIG.GESTURE.HISTORY_SIZE) {
    rotationHistory.shift();
    }

    // 5. æ£€æµ‹æ—‹è½¬æ‰‹åŠ¿
    if (rotationHistory.length >= 3) {
    detectSimpleRotation(rotationHistory);
    }
    };

    // æ·»åŠ äº‹ä»¶ç›‘å¬
    window.addEventListener('deviceorientation', gameState.motionListener);
    console.log('é‡åŠ›æ„Ÿåº”ç›‘å¬å·²å¯åŠ¨');
    }

    // å¯ç”¨æ¸¸æˆè¿‡ç¨‹ä¸­çš„é‡åŠ›æ„Ÿåº”
    function enableGameMotion() {
    gameState.motionEnabled = true;
    console.log('æ¸¸æˆé‡åŠ›æ„Ÿåº”å·²å¯ç”¨');
    }

    // ç¦ç”¨é‡åŠ›æ„Ÿåº”ï¼ˆæ¸¸æˆç»“æŸæˆ–æš‚åœæ—¶ï¼‰
    function disableGameMotion() {
    gameState.motionEnabled = false;
    console.log('æ¸¸æˆé‡åŠ›æ„Ÿåº”å·²ç¦ç”¨');
    }

    // å®Œå…¨åœæ­¢é‡åŠ›æ„Ÿåº”ç›‘å¬
    function stopGestureListening() {
    if (gameState.motionListener) {
    window.removeEventListener('deviceorientation', gameState.motionListener);
    gameState.motionListener = null;
    console.log('é‡åŠ›æ„Ÿåº”ç›‘å¬å·²åœæ­¢');
    }
    disableGameMotion();
    }

    // ç®€åŒ–çš„æ—‹è½¬æ£€æµ‹
    function detectSimpleRotation(history) {
    // æ£€æŸ¥é‡åŠ›æ„Ÿåº”æ˜¯å¦å¯ç”¨
    if (!gameState.motionEnabled) {
    return;
    }
    const now = Date.now();

    // å†·å´æ—¶é—´æ£€æŸ¥
    if (now - gameState.lastGestureTime < CONFIG.GESTURE.COOLDOWN) {
    return;
    }

    // å–æœ€è¿‘çš„æ•°æ®ç‚¹
    const recentPoints = history.slice(-4); // å–æœ€è¿‘4ä¸ªç‚¹

    // è®¡ç®—è§’åº¦å˜åŒ–
    const firstAngle = recentPoints[0].angle;
    const lastAngle = recentPoints[recentPoints.length - 1].angle;
    const timeDiff = recentPoints[recentPoints.length - 1].time - recentPoints[0].time;

    // è®¡ç®—æ€»è§’åº¦å˜åŒ–ï¼ˆè€ƒè™‘360åº¦è¾¹ç•Œï¼‰
    let totalAngleChange = lastAngle - firstAngle;
    if (totalAngleChange > 180) totalAngleChange -= 360;
    if (totalAngleChange < -180) totalAngleChange += 360;

    // è®¡ç®—æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
    const rotationSpeed = timeDiff > 0 ? Math.abs(totalAngleChange) / (timeDiff / 1000) : 0;

    console.log(`è§’åº¦å˜åŒ–: ${totalAngleChange.toFixed(1)}Â°, é€Ÿåº¦: ${rotationSpeed.toFixed(1)}Â°/ç§’`);

    // æ£€æµ‹æ¡ä»¶
    const absAngleChange = Math.abs(totalAngleChange);

    // æ¡ä»¶1: è§’åº¦å˜åŒ–è¶³å¤Ÿå¤§
    const isAngleSufficient = absAngleChange >= CONFIG.GESTURE.MIN_ROTATION_ANGLE &&
    absAngleChange <= CONFIG.GESTURE.MAX_ROTATION_ANGLE;

    // æ¡ä»¶2: æ—‹è½¬é€Ÿåº¦è¶³å¤Ÿå¿«
    const isSpeedSufficient = rotationSpeed >= CONFIG.GESTURE.ROTATION_SPEED_THRESHOLD;

    // æ¡ä»¶3: æ£€æŸ¥æ—‹è½¬æ–¹å‘æ˜¯å¦ä¸€è‡´
    const isDirectionConsistent = checkDirectionConsistency(recentPoints);

    if (isAngleSufficient && isSpeedSufficient && isDirectionConsistent) {
    // ç¡®å®šæ—‹è½¬æ–¹å‘
    if (totalAngleChange < 0) {
    // è´Ÿè§’åº¦å˜åŒ– = é¡ºæ—¶é’ˆæ—‹è½¬
    console.log(`æ£€æµ‹åˆ°é¡ºæ—¶é’ˆæ—‹è½¬: ${absAngleChange.toFixed(1)}Â°`);
    triggerGesture('clockwise');
    rotationHistory.length = 0; // æ¸…ç©ºå†å²ï¼Œé¿å…é‡å¤æ£€æµ‹
    } else if (totalAngleChange > 0) {
    // æ­£è§’åº¦å˜åŒ– = é€†æ—¶é’ˆæ—‹è½¬
    console.log(`æ£€æµ‹åˆ°é€†æ—¶é’ˆæ—‹è½¬: ${absAngleChange.toFixed(1)}Â°`);
    triggerGesture('counterclockwise');
    rotationHistory.length = 0; // æ¸…ç©ºå†å²
    }
    }
    }

    // æ£€æŸ¥æ–¹å‘ä¸€è‡´æ€§
    function checkDirectionConsistency(points) {
    if (points.length < 3) return true;

    let consistentCount = 0;
    for (let i = 1; i < points.length; i++) {
    const angleDiff = points[i].angle - points[i - 1].angle;

    // æ£€æŸ¥ä¸»è¦æ–¹å‘
    if (Math.abs(angleDiff) > 2) { // å¿½ç•¥å¾®å°å˜åŒ–
    const firstSign = Math.sign(points[1].angle - points[0].angle);
    const currentSign = Math.sign(angleDiff);

    if (firstSign === currentSign) {
    consistentCount++;
    }
    }
    }

    // è‡³å°‘70%çš„æ•°æ®ç‚¹æ–¹å‘ä¸€è‡´
    return consistentCount >= Math.floor((points.length - 1) * 0.7);
    }

    // è§¦å‘æ‰‹åŠ¿
    function triggerGesture(direction) {
    const now = Date.now();
    const cooldown = gameState.lastGestureTime ? CONFIG.GESTURE.COOLDOWN : 0;

    if (now - gameState.lastGestureTime < cooldown) {
    console.log('æ‰‹åŠ¿å†·å´ä¸­...');
    return;
    }

    gameState.lastGestureTime = now;

    // æä¾›å³æ—¶è§†è§‰åé¦ˆ
    const feedback = document.createElement('div');
    feedback.className = 'instant-feedback';
    feedback.style.cssText = `
               position: fixed;
               top: 50%;
               left: 50%;
               transform: translate(-50%, -50%);
               font-size: 4rem;
               z-index: 9999;
               pointer-events: none;
               animation: popIn 0.3s ease-out;
           `;

    if (direction === 'clockwise') {
    feedback.textContent = 'âœ…';
    feedback.style.color = '#2ed573';
    console.log('è§¦å‘ï¼šé¡ºæ—¶é’ˆæ—‹è½¬ - çŒœå¯¹');
    setTimeout(() => markCorrect(), 50); // å»¶è¿Ÿ50msæ‰§è¡Œï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
    } else {
    feedback.textContent = 'â­ï¸';
    feedback.style.color = '#ff9f43';
    console.log('è§¦å‘ï¼šé€†æ—¶é’ˆæ—‹è½¬ - è·³è¿‡');
    setTimeout(() => skipWord(), 50);
    }

    document.body.appendChild(feedback);

    setTimeout(() => {
    feedback.style.opacity = '0';
    feedback.style.transition = 'opacity 0.2s ease';
    setTimeout(() => feedback.remove(), 200);
    }, 300);
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function showSection(section) {
    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    if (section !== 'theme') {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.querySelectorAll('.game-section').forEach(el => {
    el.classList.remove('active-section');
    });

    const target = document.getElementById(section + 'Section');
    if (target) target.classList.add('active-section');

    // å½“ç¦»å¼€æ¸¸æˆç•Œé¢æ—¶ï¼Œç¦ç”¨é‡åŠ›æ„Ÿåº”
    if (section !== 'game') {
    disableGameMotion();
    }
    }

    function showLoader(show) {
    elements.loader.style.display = show ? 'block' : 'none';
    }

    function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
    }

    // é»˜è®¤ä¸»é¢˜æ•°æ®ï¼ˆå¤‡ç”¨ï¼‰
    function getDefaultThemes() {
    return [
    {
    id: 'æˆè¯­',
    name: 'æˆè¯­',
    icon: 'fas fa-book-open',
    color: '#2575fc',
    words: ['ç”»è›‡æ·»è¶³', 'å®ˆæ ªå¾…å…”', 'åˆ»èˆŸæ±‚å‰‘', 'å¶å…¬å¥½é¾™', 'ç‹å‡è™å¨']
    },
    {
    id: 'åäººæ˜æ˜Ÿ',
    name: 'åäººæ˜æ˜Ÿ',
    icon: 'fas fa-star',
    color: '#ff9f43',
    words: ['å‘¨æ°ä¼¦', 'åˆ˜å¾·å', 'å¼ å­¦å‹', 'ç‹è²', 'æ—ä¿Šæ°']
    }
    ];
    }

    // é»˜è®¤è¯è¯­æ•°æ®å‡½æ•°ï¼ˆç°åœ¨ç›´æ¥åœ¨ä¸»å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¸å†å•ç‹¬è°ƒç”¨ï¼‰
    function getDefaultWords(filename) {
    // è¿™æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬ç›´æ¥ä»æ–‡ä»¶ä¸­åŠ è½½è¯è¯­
    // åªåœ¨æ–‡ä»¶åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨
    const defaults = {
    'æˆè¯­.txt': ['ç”»è›‡æ·»è¶³', 'å®ˆæ ªå¾…å…”', 'åˆ»èˆŸæ±‚å‰‘', 'å¶å…¬å¥½é¾™', 'ç‹å‡è™å¨'],
    'åäººæ˜æ˜Ÿ.txt': ['å‘¨æ°ä¼¦', 'åˆ˜å¾·å', 'å¼ å­¦å‹', 'ç‹è²', 'æ—ä¿Šæ°'],
    'ç¾é£Ÿ.txt': ['ç«é”…', 'æŠ«è¨', 'æ±‰å ¡', 'å¯¿å¸', 'æ‹‰é¢'],
    'è¿åŠ¨.txt': ['ç¯®çƒ', 'è¶³çƒ', 'æ¸¸æ³³', 'è·‘æ­¥', 'ç‘œä¼½'],
    'ç”µå½±.txt': ['é˜¿å‡¡è¾¾', 'æ³°å¦å°¼å…‹å·', 'å¤ä»‡è€…è”ç›Ÿ', 'æ•™çˆ¶', 'æ˜Ÿçƒå¤§æˆ˜'],
    'åŠ¨ç‰©.txt': ['ç†ŠçŒ«', 'è€è™', 'ç‹®å­', 'å¤§è±¡', 'é•¿é¢ˆé¹¿']
    };
    return defaults[filename] || [];
    }
    function getDefaultThemes() {
    return [
    {
    id: 'æˆè¯­',
    name: 'æˆè¯­',
    icon: 'fas fa-book-open',
    color: '#2575fc',
    words: getDefaultWords('æˆè¯­.txt')
    },
    {
    id: 'åäººæ˜æ˜Ÿ',
    name: 'åäººæ˜æ˜Ÿ',
    icon: 'fas fa-star',
    color: '#ff9f43',
    words: getDefaultWords('åäººæ˜æ˜Ÿ.txt')
    }
    ];
    }

    // ==================== éŸ³æ•ˆåŠŸèƒ½ ====================

    // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
    function initAudioSystem() {
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Audio API
    if (!window.AudioContext && !window.webkitAudioContext) {
    console.log('æµè§ˆå™¨ä¸æ”¯æŒWeb Audio APIï¼Œå°†ä½¿ç”¨HTML5 Audio');
    return;
    }

    try {
    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
    gameState.audioContext = new AudioContextClass();

    // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åï¼‰
    if (gameState.audioContext.state === 'suspended') {
    document.addEventListener('click', function resumeAudio() {
    gameState.audioContext.resume();
    document.removeEventListener('click', resumeAudio);
    });
    }
    } catch (error) {
    console.log('åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', error);
    }
    }

    // åˆ‡æ¢éŸ³æ•ˆçŠ¶æ€
    function toggleAudio() {
    gameState.audioEnabled = !gameState.audioEnabled;

    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = audioToggle.querySelector('i');

    if (gameState.audioEnabled) {
    audioToggle.classList.remove('muted');
    audioIcon.className = 'fas fa-volume-up';
    audioToggle.title = 'å…³é—­éŸ³æ•ˆ';

    // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
    if (gameState.audioContext && gameState.audioContext.state === 'suspended') {
    gameState.audioContext.resume();
    }
    } else {
    audioToggle.classList.add('muted');
    audioIcon.className = 'fas fa-volume-mute';
    audioToggle.title = 'å¼€å¯éŸ³æ•ˆ';

    // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
    stopAllAudio();
    }

    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('audioEnabled', gameState.audioEnabled);
    }

    // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
    function stopAllAudio() {
    if (gameState.countdownAudio) {
    gameState.countdownAudio.pause();
    gameState.countdownAudio.currentTime = 0;
    }
    }

    // æ’­æ”¾å€’è®¡æ—¶èƒŒæ™¯éŸ³ä¹
    function playCountdownMusic() {
    if (!gameState.audioEnabled) return;

    // åœæ­¢ä¹‹å‰çš„éŸ³ä¹
    stopAllAudio();


    }

    // ä½¿ç”¨Web Audio APIåˆæˆå€’è®¡æ—¶éŸ³æ•ˆ
    function playSyntheticCountdown() {
    try {
    const context = gameState.audioContext;
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    oscillator.frequency.value = 220; // A3éŸ³ç¬¦
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0, context.currentTime);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.3, context.currentTime + 0.1);

    oscillator.start();

    // åœ¨å€’è®¡æ—¶ç»“æŸæ—¶æ·¡å‡º
    setTimeout(() => {
    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);
    setTimeout(() => oscillator.stop(), 500);
    }, 4500); // 4.5ç§’åå¼€å§‹æ·¡å‡º
    } catch (error) {
    console.log('åˆæˆéŸ³æ•ˆå¤±è´¥:', error);
    playFallbackCountdown();
    }
    }

    // åå¤‡å€’è®¡æ—¶éŸ³æ•ˆï¼ˆä½¿ç”¨ç®€å•çš„beepå£°ï¼‰
    function playFallbackCountdown() {
    try {
    // åˆ›å»ºä¸€ä¸ªbeepéŸ³æ•ˆ
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    // æ¯ç§’é’Ÿbeepä¸€æ¬¡
    for (let i = 0; i < 5; i++) {
    const time = context.currentTime + i;

    gainNode.gain.setValueAtTime(0, time);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.5, time + 0.1);
    gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.5);

    oscillator.frequency.setValueAtTime(440, time); // A4éŸ³ç¬¦
    if (i === 4) {
    oscillator.frequency.setValueAtTime(880, time); // æœ€åä¸€æ¬¡é«˜å…«åº¦
    }
    }

    oscillator.start();
    oscillator.stop(context.currentTime + 5);
    } catch (error) {
    console.log('åå¤‡éŸ³æ•ˆå¤±è´¥:', error);
    }
    }

    // æ’­æ”¾å€’è®¡æ—¶æ•°å­—éŸ³æ•ˆ
    // æ’­æ”¾å€’è®¡æ—¶æ•°å­—éŸ³æ•ˆ - ç”µå­è¡¨æ»´å£°ç‰ˆ
    function playCountdownBeep(number) {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();

    // åˆ›å»ºä¸¤ä¸ªæŒ¯è¡å™¨æ¨¡æ‹Ÿç”µå­éŸ³æ•ˆ
    const osc1 = context.createOscillator();
    const osc2 = context.createOscillator();
    const gainNode = context.createGain();

    osc1.connect(gainNode);
    osc2.connect(gainNode);
    gainNode.connect(context.destination);

    // ç”µå­è¡¨å¸¸ç”¨çš„é¢‘ç‡
    const baseFreq = number === 1 ? 1000 : 800; // æœ€åä¸€å£°æ›´é«˜
    osc1.frequency.value = baseFreq;
    osc2.frequency.value = baseFreq * 1.5; // åˆ¶é€ ç”µå­æ„Ÿ

    osc1.type = 'square';
    osc2.type = 'triangle';

    const now = context.currentTime;

    // æå¿«çš„èµ·éŸ³ï¼ˆç±»ä¼¼ç”µå­è¡¨çš„"æ»´"å£°ï¼‰
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.7, now + 0.002); // 2ms!

    // éå¸¸å¿«é€Ÿçš„è¡°å‡
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.08); // 80msæ€»æ—¶é•¿

    osc1.start();
    osc2.start();

    // çŸ­æš‚æŒç»­æ—¶é—´
    osc1.stop(now + 0.08);
    osc2.stop(now + 0.08);

    } catch (error) {
    console.log('æ’­æ”¾beepéŸ³æ•ˆå¤±è´¥:', error);
    }
    }

    // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
    function playGameStartSound() {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();
    const oscillator1 = context.createOscillator();
    const oscillator2 = context.createOscillator();
    const gainNode = context.createGain();

    oscillator1.connect(gainNode);
    oscillator2.connect(gainNode);
    gainNode.connect(context.destination);

    // ä¸¤ä¸ªæŒ¯è¡å™¨åˆ›é€ å’Œå¼¦æ•ˆæœ
    oscillator1.frequency.value = 523.25; // C5
    oscillator2.frequency.value = 659.25; // E5
    oscillator1.type = 'sine';
    oscillator2.type = 'sine';

    gainNode.gain.setValueAtTime(0, context.currentTime);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume, context.currentTime + 0.1);
    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 1);

    oscillator1.start();
    oscillator2.start();

    oscillator1.stop(context.currentTime + 1);
    oscillator2.stop(context.currentTime + 1);
    } catch (error) {
    console.log('æ’­æ”¾å¼€å§‹éŸ³æ•ˆå¤±è´¥:', error);
    }
    }

    // æ’­æ”¾æ‰‹åŠ¿åé¦ˆéŸ³æ•ˆ
    function playGestureSound(isCorrect) {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    if (isCorrect) {
    // æ­£ç¡®éŸ³æ•ˆ - ä¸Šå‡éŸ³è°ƒ
    // æ­£ç¡®éŸ³æ•ˆ - ç»å…¸æ­£ç¡®ç­”æ¡ˆé“ƒå£°
    playCorrectSound(context);
    } else {
    // è·³è¿‡éŸ³æ•ˆ - ä¸‹é™éŸ³è°ƒ
    oscillator.frequency.setValueAtTime(880, context.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(440, context.currentTime + 0.2);
    oscillator.type = 'triangle';
    }

    gainNode.gain.setValueAtTime(0, context.currentTime);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.5, context.currentTime + 0.05);
    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.2);

    oscillator.start();
    oscillator.stop(context.currentTime + 0.2);
    } catch (error) {
    console.log('æ’­æ”¾æ‰‹åŠ¿éŸ³æ•ˆå¤±è´¥:', error);
    }
    }
    // ç®€å•ç»å…¸çš„"å®"å£°æ­£ç¡®ç­”æ¡ˆéŸ³æ•ˆ
    function playCorrectSound(context) {
    try {
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    const now = context.currentTime;

    // æ¸…è„†çš„é«˜é¢‘"å®"å£°
    oscillator.frequency.value = 1318.51; // E6 - æ¸…è„†ä½†ä¸åˆºè€³

    // æ­£å¼¦æ³¢æœ€çº¯å‡€ï¼Œä¸‰è§’æ³¢æ›´æŸ”å’Œï¼Œæ–¹æ³¢æ›´ç”µå­æ„Ÿ
    oscillator.type = 'sine';

    // åŒ…ç»œï¼šå¿«é€Ÿèµ·éŸ³ï¼Œç¨é•¿è¡°å‡ï¼ˆæœ‰å›å“æ„Ÿï¼‰
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume * 0.7, now + 0.01); // å¿«é€Ÿèµ·éŸ³
    gainNode.gain.exponentialRampToValueAtTime(CONFIG.AUDIO.volume * 0.3, now + 0.08); // ä¿æŒ
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.25); // ç¼“æ…¢è¡°å‡

    oscillator.start();
    oscillator.stop(now + 0.25);

    } catch (error) {
    console.log('æ’­æ”¾å®å£°éŸ³æ•ˆå¤±è´¥:', error);
    }
    }
    // æ–°å¢ï¼šæ˜¾ç¤ºå½•åˆ¶ä¸æ”¯æŒçš„æç¤º
    function showRecordingNotSupported() {
    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°UIï¼Œæ¯”å¦‚éšè—å½•åˆ¶æŒ‰é’®æˆ–æ˜¾ç¤ºæç¤º
    console.log('å½•åˆ¶åŠŸèƒ½åœ¨æ­¤è®¾å¤‡ä¸Šä¸å¯ç”¨');
    }
    // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
    function playGameEndSound(score) {
    if (!gameState.audioEnabled) return;

    try {
    const context = gameState.audioContext || new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    // æ ¹æ®åˆ†æ•°è°ƒæ•´éŸ³æ•ˆ
    let frequency;
    if (score >= 80) {
    frequency = [523.25, 659.25, 783.99]; // C5, E5, G5 - èƒœåˆ©å’Œå¼¦
    } else if (score >= 50) {
    frequency = [392, 493.88, 587.33]; // G4, B4, D5 - ä¸­ç­‰å’Œå¼¦
    } else {
    frequency = [349.23, 440, 523.25]; // F4, A4, C5 - åŸºæœ¬å’Œå¼¦
    }

    // æ’­æ”¾å’Œå¼¦çš„æ¯ä¸ªéŸ³ç¬¦
    frequency.forEach((freq, index) => {
    const time = context.currentTime + index * 0.1;
    oscillator.frequency.setValueAtTime(freq, time);
    });

    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0, context.currentTime);
    gainNode.gain.linearRampToValueAtTime(CONFIG.AUDIO.volume, context.currentTime + 0.1);
    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);

    oscillator.start();
    oscillator.stop(context.currentTime + 0.5);
    } catch (error) {
    console.log('æ’­æ”¾ç»“æŸéŸ³æ•ˆå¤±è´¥:', error);
    }
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    // æ–°å¢ï¼šå½•åˆ¶ç›¸å…³äº‹ä»¶ç›‘å¬




    // åœ¨äº‹ä»¶ç›‘å¬éƒ¨åˆ†æ·»åŠ è¯åº“ç®¡ç†æŒ‰é’®çš„äº‹ä»¶
    document.getElementById('manageWordsBtn').addEventListener('click', () => {
    // è·³è½¬åˆ°è¯åº“ç®¡ç†é¡µé¢
    window.location.href = 'word-manager.html';
    });
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    elements.startNowBtn.addEventListener('click', startGameNow);
    elements.cancelStartBtn.addEventListener('click', () => showSection('theme'));

    document.getElementById('correctBtn').addEventListener('click', markCorrect);
    document.getElementById('skipBtn').addEventListener('click', skipWord);
    document.getElementById('endGameBtn').addEventListener('click', endGame);

    document.getElementById('playAgainBtn').addEventListener('click', () => {
    disableGameMotion(); // æ–°å¢ï¼šç¦ç”¨é‡åŠ›æ„Ÿåº”
    showSection('theme')
    });
    document.getElementById('backToThemeBtn').addEventListener('click', () => {
    disableGameMotion(); // æ–°å¢ï¼šç¦ç”¨é‡åŠ›æ„Ÿåº”
    showSection('theme');
    });
    // åœ¨ç°æœ‰çš„äº‹ä»¶ç›‘å¬éƒ¨åˆ†æ·»åŠ 
    document.getElementById('requestMotionBtn').addEventListener('click', requestMotionPermission);

    // æ–°å¢ï¼šå›é¡¾ç›¸å…³äº‹ä»¶
    elements.toggleReview.addEventListener('click', () => toggleReview());
    // elements.showReviewBtn.addEventListener('click', showReview);

    // ==================== åˆå§‹åŒ– ====================
    // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°
    window.addEventListener('DOMContentLoaded', () => {
    initAllThemes();
    // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
    initAudioSystem();
    // åˆå§‹åŒ–ç´§å¼ éŸ³æ•ˆ
    initTenseAudio();
    // ä»localStorageåŠ è½½éŸ³æ•ˆè®¾ç½®
    const savedAudioSetting = localStorage.getItem('audioEnabled');
    if (savedAudioSetting !== null) {
    gameState.audioEnabled = JSON.parse(savedAudioSetting);
    }
    // æ£€æŸ¥å½•åˆ¶æ”¯æŒï¼ˆä¿®æ”¹è¿™éƒ¨åˆ†ï¼‰
    console.log('æ£€æŸ¥è®¾å¤‡æ”¯æŒå½•åˆ¶åŠŸèƒ½');
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
    console.log('è®¾å¤‡ä¸æ”¯æŒå½•åˆ¶åŠŸèƒ½');
    gameState.recordingEnabled = false;
    } else {
    gameState.recordingEnabled = CONFIG.RECORDING.enabled;
    console.log('è®¾å¤‡æ”¯æŒå½•åˆ¶åŠŸèƒ½ï¼Œå½•åˆ¶å¼€å…³:', gameState.recordingEnabled);
    }


    // æ›´æ–°éŸ³æ•ˆæŒ‰é’®çŠ¶æ€
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = audioToggle.querySelector('i');
    if (!gameState.audioEnabled) {
    audioToggle.classList.add('muted');
    audioIcon.className = 'fas fa-volume-mute';
    audioToggle.title = 'å¼€å¯éŸ³æ•ˆ';
    }

    // æ£€æŸ¥è®¾å¤‡æ”¯æŒæƒ…å†µå¹¶æ›´æ–°UI
    if (!motionState.isSupported) {
    const requestBtn = document.getElementById('requestMotionBtn');
    requestBtn.disabled = true;
    requestBtn.innerHTML = '<i class="fas fa-ban"></i> è®¾å¤‡ä¸æ”¯æŒ';
    requestBtn.style.opacity = '0.6';
    }

    // æ·»åŠ CSSåŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
               @keyframes pulse {
                   0%, 100% { opacity: 1; }
                   50% { opacity: 0.7; }
               }
           `;
    document.head.appendChild(style);
    });
    // ==================== æ–°å¢ï¼šåé¦ˆåŠŸèƒ½äº‹ä»¶ç›‘å¬ ====================
    // åœ¨ç°æœ‰çš„äº‹ä»¶ç›‘å¬éƒ¨åˆ†æ·»åŠ éŸ³æ•ˆæ§åˆ¶
    document.getElementById('audioToggle').addEventListener('click', toggleAudio);

    document.getElementById('feedbackTrigger').addEventListener('click', function (e) {
    e.preventDefault();
    document.getElementById('feedbackModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    });

    document.querySelector('.close-modal').addEventListener('click', function () {
    document.getElementById('feedbackModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    });

    document.getElementById('feedbackModal').addEventListener('click', function (e) {
    if (e.target === this) {
    this.style.display = 'none';
    document.body.style.overflow = 'auto';
    }
    });

    document.getElementById('sendEmailBtn').addEventListener('click', function () {
    const message = document.getElementById('userMessage').value.trim();

    if (!message) {
    alert('è¯·è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹');
    document.getElementById('userMessage').focus();
    return;
    }

    // è·å–ç”¨æˆ·è®¾å¤‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    const deviceInfo = `è®¾å¤‡ä¿¡æ¯: ${navigator.userAgent}`;
    const gameVersion = `æ¸¸æˆç‰ˆæœ¬: 1.0`;

    // æ„é€ é‚®ä»¶å†…å®¹
    const subject = encodeURIComponent('ã€ä½ è¯´æˆ‘çŒœæ¸¸æˆã€‘ç”¨æˆ·åé¦ˆ');
    const body = encodeURIComponent(`ç”¨æˆ·åé¦ˆå†…å®¹ï¼š\n\n${message}\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n${gameVersion}\n${deviceInfo}\n\næ„Ÿè°¢æ‚¨çš„åé¦ˆï¼`);


    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('userMessage').value = '';

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    const sendBtn = this;
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-check"></i> é‚®ä»¶å®¢æˆ·ç«¯å·²æ‰“å¼€';
    sendBtn.style.background = '#2ed573';

    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æŒ‰é’®çŠ¶æ€å˜åŒ–
    // æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯
    setTimeout(() => {
    window.location.href = `mailto:ming95ming@126.com?subject=${subject}&body=${body}`;
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    setTimeout(() => {
    sendBtn.innerHTML = originalText;
    sendBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }, 1000);

    }, 300);
    });

    // å½“å¼¹çª—æ‰“å¼€æ—¶è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
    document.getElementById('feedbackModal').addEventListener('click', function (e) {
    if (e.target === this || e.target.classList.contains('close-modal')) {
    return;
    }
    setTimeout(() => {
    document.getElementById('userMessage').focus();
    }, 300);
    });

    // ç¡®ä¿é¡µé¢å†…å®¹ä¸ä¼šè¢«åº•éƒ¨æ é®æŒ¡
    function adjustContentPadding() {
    const footerHeight = document.getElementById('globalFooter').offsetHeight;
    document.body.style.paddingBottom = footerHeight + 20 + 'px';
    }

    // é¡µé¢åŠ è½½å®Œæˆåè°ƒæ•´å†…è¾¹è·
    window.addEventListener('load', adjustContentPadding);
    window.addEventListener('resize', adjustContentPadding);

    // é˜»æ­¢åœ¨åé¦ˆå¼¹çª—å†…æ»šåŠ¨æ—¶èƒŒæ™¯æ»šåŠ¨
    document.getElementById('feedbackModal').addEventListener('touchmove', function (e) {
    if (e.target === this) {
    e.preventDefault();
    }
    }, { passive: false });
</script>

</body>
