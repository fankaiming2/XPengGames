<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ è¯´æˆ‘çŒœ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 25px;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 {
            color: #2575fc;
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            color: #666;
            font-size: 1rem;
            font-weight: 400;
        }
        
        .game-section {
            display: none;
            text-align: center;
        }
        
        .active-section {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .theme-card {
            background: white;
            border-radius: 18px;
            padding: 25px 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .theme-card:hover, .theme-card:active {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .theme-card.selected {
            border-color: #2575fc;
            background-color: #f0f7ff;
        }
        
        .theme-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        
        .theme-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .time-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }
        
        .time-option {
            padding: 15px 25px;
            background: #f0f7ff;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #2575fc;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            border: 2px solid transparent;
        }
        
        .time-option:hover, .time-option:active {
            background: #2575fc;
            color: white;
        }
        
        .time-option.selected {
            background: #2575fc;
            color: white;
            border-color: #1c5dc1;
            box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
        }
        
        .game-area {
            margin: 30px 0;
            position: relative;
        }
        
        .word-card {
            background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 20px;
            font-size: 2.8rem;
            font-weight: 700;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(37, 117, 252, 0.3);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            word-break: break-word;
        }
        
        .timer {
            font-size: 3.5rem;
            font-weight: 800;
            color: #294dde;
            margin: 20px 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .timer-ms {
            font-size: 1.8rem;
            color: #2c48d7;
            margin-top: -10px;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 18px 35px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
        }
        
        .btn-primary {
            background: #2575fc;
            color: white;
            box-shadow: 0 8px 20px rgba(37, 117, 252, 0.3);
        }
        
        .btn-primary:hover, .btn-primary:active {
            background: #1c5dc1;
            transform: translateY(-3px);
        }
        
        .btn-secondary {
            background: #f1f2f6;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: #e0e2e9;
        }
        
        .btn-success {
            background: #2ed573;
            color: white;
            box-shadow: 0 8px 20px rgba(46, 213, 115, 0.3);
        }
        
        .btn-success:hover, .btn-success:active {
            background: #25b562;
            transform: translateY(-3px);
        }
        
        .shake-hint {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: center; /* ç¡®ä¿å‚ç›´å±…ä¸­ */
            justify-content: center;
            gap: 15px; /* å¢åŠ é—´è· */
            color: #666;
            font-size: 1rem;
            border: 2px dashed #2575fc;
            min-height: 80px; /* è®¾ç½®æœ€å°é«˜åº¦ */
        }
        .shake-hint > div {
            text-align: left;
            line-height: 1.4;
        }

        .shake-hint p {
            margin: 2px 0;
        }
        /* æ¸¸æˆç•Œé¢çš„æ‰‹åŠ¿æç¤ºéƒ¨åˆ† */
        #gameSection .shake-hint {
            align-items: center;
            justify-content: flex-start;
            padding: 15px 20px;
        }

        #gameSection .shake-hint .shake-icon {
            font-size: 2.2rem;
            margin-right: 15px;
        }
        .shake-icon {
            color: #2575fc;
            font-size: 2rem; /* ç¨å¾®å¢å¤§å›¾æ ‡ */
            animation: shake 2s infinite;
            flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        
        .result-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 25px 0;
            text-align: center;
        }
        
        .score {
            font-size: 4rem;
            font-weight: 800;
            color: #2575fc;
            margin: 15px 0;
        }
        
        .result-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff4757;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* æ–°å¢ï¼šé‡åŠ›æ„Ÿåº”åé¦ˆæ ·å¼ */
        .gesture-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            font-size: 4rem;
            animation: gestureFeedback 0.5s ease;
            pointer-events: none;
        }
        
        @keyframes gestureFeedback {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        
        @media (max-width: 500px) {
            .container {
                padding: 20px;
                border-radius: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .word-card {
                font-size: 2.2rem;
                min-height: 160px;
                padding: 30px 15px;
            }
            
            .timer {
                font-size: 2.8rem;
            }
            
            .timer-ms {
                font-size: 1.4rem;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
        
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 5px solid rgba(37, 117, 252, 0.2);
            border-top: 5px solid #2575fc;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timer-area {
            margin: 20px 0;
        }

        .timer {
            font-size: 3.5rem;
            font-weight: 800;
            color: #2575fc;
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: baseline;
            justify-content: center;
        }

        .timer-ms {
            font-size: 1.8rem;
            font-weight: 700;
            margin-left: 2px;
        }

        /* è®¡æ—¶å™¨ç´§å¼ çŠ¶æ€æ ·å¼è°ƒæ•´ */
        .timer.timer-low {
            color: #293ed9;
            animation: pulse 1s infinite;
        }

        .timer.timer-low .timer-ms {
            color: #6c47ff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes rotateClockwise {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes rotateCounterclockwise {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .rotate-clockwise {
            animation: rotateClockwise 0.5s ease;
        }

        .rotate-counterclockwise {
            animation: rotateCounterclockwise 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-gamepad"></i> ä½ è¯´æˆ‘çŒœ</h1>
        </div>
        
        <section id="themeSection" class="game-section active-section">
            <h2>é€‰æ‹©çŒœè¯ä¸»é¢˜</h2>
            <div class="theme-grid" id="themeGrid">
                <!-- ä¸»é¢˜å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="time-options" id="timeOptions">
                <!-- æ—¶é—´é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="game-controls">
                <button class="btn btn-primary" id="startGameBtn">
                    <i class="fas fa-play-circle"></i> å¼€å§‹æ¸¸æˆ
                </button>
            </div>
            
            <div class="shake-hint">
                <i class="fas fa-mobile-alt shake-icon"></i>
                <span>é¡ºæ—¶é’ˆæ™ƒåŠ¨çŒœå¯¹ Â· é€†æ—¶é’ˆæ™ƒåŠ¨è·³è¿‡</span>
            </div>
        </section>
        
        <section id="gameSection" class="game-section">
            <div class="game-area">
                <h2 id="currentTheme">æˆè¯­çŒœçŒœçŒœ</h2>
                <div class="word-card" id="currentWord">
                    è¯è¯­åŠ è½½ä¸­...
                </div>
                
                <div class="timer-area">
                    <div class="timer" id="timer">
                        03:00
                        <span class="timer-ms" id="timerMs">.000</span>
                    </div>
                </div>
                
                <div class="result-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">çŒœå¯¹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="skippedCount">0</div>
                        <div class="stat-label">è·³è¿‡</div>
                    </div>
                    <!-- <div class="stat-item">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">æ€»æ•°</div>
                    </div> -->
                </div>
            </div>
            
            <div class="game-controls">
                <button class="btn btn-success" id="correctBtn">
                    <i class="fas fa-check-circle"></i> çŒœå¯¹äº†
                </button>
                <button class="btn btn-secondary" id="skipBtn">
                    <i class="fas fa-forward"></i> è·³è¿‡
                </button>
                <button class="btn btn-secondary" id="endGameBtn">
                    <i class="fas fa-stop-circle"></i> ç»“æŸæ¸¸æˆ
                </button>
            </div>
            
            <div class="shake-hint">
                <i class="fas fa-mobile-alt shake-icon"></i>
                <div>
                    <p>ğŸ“± æ‰‹åŠ¿æ§åˆ¶ï¼š</p>
                    <p>é¡ºæ—¶é’ˆæ—‹è½¬ = çŒœå¯¹</p>
                    <p>é€†æ—¶é’ˆæ—‹è½¬ = è·³è¿‡</p>
                </div>
            </div>
        </section>
        
        <section id="resultSection" class="game-section">
            <div class="result-card">
                <h2>æ¸¸æˆç»“æŸï¼</h2>
                <p>ä½ çš„æœ€ç»ˆå¾—åˆ†</p>
                <div class="score" id="finalScore">0</div>
                
                <div class="result-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="finalCorrect">0</div>
                        <div class="stat-label">çŒœå¯¹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalSkipped">0</div>
                        <div class="stat-label">è·³è¿‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalTotal">0</div>
                        <div class="stat-label">æ€»æ•°</div>
                    </div>
                </div>
                
                <p id="resultMessage">ç»§ç»­åŠ æ²¹ï¼</p>
            </div>
            
            <div class="game-controls">
                <button class="btn btn-primary" id="playAgainBtn">
                    <i class="fas fa-redo"></i> å†ç©ä¸€æ¬¡
                </button>
                <button class="btn btn-secondary" id="backToThemeBtn">
                    <i class="fas fa-palette"></i> é€‰æ‹©å…¶ä»–ä¸»é¢˜
                </button>
            </div>
        </section>
        
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>æ¸¸æˆåŠ è½½ä¸­...</p>
        </div>
    </div>

    <script>
        // ==================== é…ç½®åŒºåŸŸ ====================
        const CONFIG = {
            // ä¸»é¢˜é…ç½®æ–‡ä»¶æ˜ å°„ï¼ˆæ–‡ä»¶å -> æ˜¾ç¤ºåç§°ï¼‰
            themeFiles: {
                'idiom.txt': 'æˆè¯­',
                'star.txt': 'æ˜æ˜Ÿ',
                'food.txt': 'ç¾é£Ÿ',
                'sport.txt': 'è¿åŠ¨',
                'movie.txt': 'ç”µå½±',
                'animal.txt': 'åŠ¨ç‰©'
            },
            
            // ä¸»é¢˜å›¾æ ‡æ˜ å°„
            themeIcons: {
                'æˆè¯­': 'fas fa-book-open',
                'æ˜æ˜Ÿ': 'fas fa-star',
                'ç¾é£Ÿ': 'fas fa-utensils',
                'è¿åŠ¨': 'fas fa-running',
                'ç”µå½±': 'fas fa-film',
                'åŠ¨ç‰©': 'fas fa-paw'
            },
            
            // ä¸»é¢˜é¢œè‰²æ˜ å°„
            themeColors: {
                'æˆè¯­': '#2575fc',
                'æ˜æ˜Ÿ': '#ff9f43',
                'ç¾é£Ÿ': '#ee5a24',
                'è¿åŠ¨': '#2ed573',
                'ç”µå½±': '#6c5ce7',
                'åŠ¨ç‰©': '#00d2d3'
            },
            
            // é‡åŠ›æ„Ÿåº”é…ç½® - ä¿®æ”¹ä¸ºæ—‹è½¬æ£€æµ‹
            GESTURE: {
                MIN_ROTATION_ANGLE: 15,      // æœ€å°æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰- æ›´çµæ•
                MAX_ROTATION_ANGLE: 90,       // æœ€å¤§æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰- é¿å…è¿‡åº¦æ—‹è½¬
                ROTATION_SPEED_THRESHOLD: 45, // æœ€å°æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰- é™ä½è¦æ±‚
                COOLDOWN: 600,                // æ‰‹åŠ¿å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- ç¼©çŸ­
                DEBOUNCE_TIME: 200,           // é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                HISTORY_SIZE: 8               // å†å²è®°å½•å¤§å°
            },
            // æ—¶é—´é€‰é¡¹
            timeOptions: [1, 2, 3]
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        const gameState = {
            themes: [],              // ä»æ–‡ä»¶åŠ è½½çš„ä¸»é¢˜æ•°æ®
            currentTheme: null,
            selectedTime: 2,
            timer: null,
            timeLeft: 0,            // æ€»ç§’æ•°
            timeLeftMs: 0,          // æ¯«ç§’éƒ¨åˆ†
            currentWordIndex: 0,
            correctCount: 0,
            skippedCount: 0,
            totalWordsShown: 0,
            wordsForGame: [],
            lastGestureTime: 0,     // ä¸Šæ¬¡æ‰‹åŠ¿æ—¶é—´æˆ³
            lastAcceleration: { x: 0, y: 0, z: 0 } // ä¸Šæ¬¡åŠ é€Ÿåº¦å€¼
        };

        // ==================== DOMå…ƒç´  ====================
        const elements = {
            themeGrid: document.getElementById('themeGrid'),
            timeOptions: document.getElementById('timeOptions'),
            currentTheme: document.getElementById('currentTheme'),
            currentWord: document.getElementById('currentWord'),
            timer: document.getElementById('timer'),
            timerMs: document.getElementById('timerMs'),
            correctCount: document.getElementById('correctCount'),
            skippedCount: document.getElementById('skippedCount'),
            // totalCount: document.getElementById('totalCount'),
            finalScore: document.getElementById('finalScore'),
            finalCorrect: document.getElementById('finalCorrect'),
            finalSkipped: document.getElementById('finalSkipped'),
            finalTotal: document.getElementById('finalTotal'),
            resultMessage: document.getElementById('resultMessage'),
            loader: document.getElementById('loader')
        };

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================

        // 1. ä»TXTæ–‡ä»¶åŠ è½½è¯è¯­åº“
        async function loadWordFile(filename) {
            try {
                const response = await fetch(`words/${filename}`);
                if (!response.ok) throw new Error(`æ— æ³•åŠ è½½æ–‡ä»¶: ${filename}`);
                
                const text = await response.text();
                const words = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#') && !line.startsWith('//'));
                
                console.log(`åŠ è½½ä¸»é¢˜ ${filename}: ${words.length} ä¸ªè¯è¯­`);
                return words;
            } catch (error) {
                console.error('åŠ è½½è¯è¯­æ–‡ä»¶å¤±è´¥:', error);
                return getDefaultWords(filename);
            }
        }

        // 2. åˆå§‹åŒ–æ‰€æœ‰ä¸»é¢˜
        async function initAllThemes() {
            showLoader(true);
            gameState.themes = [];
            
            for (const [filename, themeName] of Object.entries(CONFIG.themeFiles)) {
                const words = await loadWordFile(filename);
                if (words.length > 0) {
                    gameState.themes.push({
                        id: filename.replace('.txt', ''),
                        name: themeName,
                        icon: CONFIG.themeIcons[themeName] || 'fas fa-question-circle',
                        color: CONFIG.themeColors[themeName] || '#888',
                        words: words
                    });
                }
            }
            
            // å¦‚æœæ²¡åŠ è½½åˆ°ä»»ä½•ä¸»é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            if (gameState.themes.length === 0) {
                console.log('ä½¿ç”¨é»˜è®¤ä¸»é¢˜æ•°æ®');
                gameState.themes = getDefaultThemes();
            }
            
            initThemeSelection();
            showLoader(false);
            console.log(`æˆåŠŸåŠ è½½ ${gameState.themes.length} ä¸ªä¸»é¢˜`);
        }

        // 3. åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©ç•Œé¢
        function initThemeSelection() {
            elements.themeGrid.innerHTML = '';
            gameState.themes.forEach(theme => {
                const themeCard = document.createElement('div');
                themeCard.className = 'theme-card';
                themeCard.dataset.id = theme.id;
                themeCard.innerHTML = `
                    <i class="${theme.icon} theme-icon" style="color:${theme.color}"></i>
                    <div class="theme-name">${theme.name}</div>
                `;
                themeCard.addEventListener('click', () => selectTheme(theme.id));
                elements.themeGrid.appendChild(themeCard);
            });
            
            // åˆå§‹åŒ–æ—¶é—´é€‰é¡¹
            initTimeOptions();
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¸»é¢˜
            if (gameState.themes.length > 0) {
                selectTheme(gameState.themes[0].id);
            }
        }

        function initTimeOptions() {
            elements.timeOptions.innerHTML = '';
            CONFIG.timeOptions.forEach(time => {
                const timeOption = document.createElement('div');
                timeOption.className = `time-option ${time === 2 ? 'selected' : ''}`;
                timeOption.textContent = `${time}åˆ†é’Ÿ`;
                timeOption.dataset.time = time;
                timeOption.addEventListener('click', () => selectTime(time));
                elements.timeOptions.appendChild(timeOption);
            });
        }

        function selectTheme(themeId) {
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`.theme-card[data-id="${themeId}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
            
            gameState.currentTheme = gameState.themes.find(t => t.id === themeId);
        }

        function selectTime(time) {
            document.querySelectorAll('.time-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`.time-option[data-time="${time}"]`);
            if (selectedOption) selectedOption.classList.add('selected');
            
            gameState.selectedTime = time;
        }

        // 4. å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!gameState.currentTheme) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼');
                return;
            }
            
            showLoader(true);
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.currentWordIndex = 0;
            gameState.correctCount = 0;
            gameState.skippedCount = 0;
            gameState.totalWordsShown = 0;
            gameState.timeLeft = gameState.selectedTime * 60;
            gameState.timeLeftMs = 0;
            resetBaselineAngle(); // é‡ç½®åŸºå‡†è§’åº¦

            // å‡†å¤‡è¯è¯­
            gameState.wordsForGame = [...gameState.currentTheme.words];
            shuffleArray(gameState.wordsForGame);
            
            // æ›´æ–°UI
            elements.currentTheme.textContent = gameState.currentTheme.name + 'çŒœçŒœçŒœ';
            
            setTimeout(() => {
                showLoader(false);
                showSection('game');
                startTimer();
                showNextWord();
                initGestureDetection();
            }, 800);
        }

        // ä¿®æ”¹è®¡æ—¶å™¨HTMLç»“æ„
        function startTimer() {
            clearInterval(gameState.timer);
            
            // è®¾ç½®åˆå§‹æ˜¾ç¤º
            elements.timer.innerHTML = `03:00<span class="timer-ms" id="timerMs">.000</span>`;
            elements.timer.classList.remove('timer-low');
            
            const startTime = Date.now();
            const totalMs = gameState.timeLeft * 1000;
            
            gameState.timer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, totalMs - elapsed);
                
                gameState.timeLeft = Math.floor(remaining / 1000);
                gameState.timeLeftMs = remaining % 1000;
                
                updateTimerDisplay();
                
                if (remaining <= 0) {
                    endGame();
                }
            }, 16);
        }

            // ä¿®æ”¹updateTimerDisplayå‡½æ•°
        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            
            // æ›´æ–°ä¸»è®¡æ—¶å™¨
            const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            elements.timer.innerHTML = `${timerText}<span class="timer-ms" id="timerMs">.${gameState.timeLeftMs.toString().padStart(3, '0')}</span>`;
            
            // ä½æ—¶é—´æé†’
            if (gameState.timeLeft < 10) {
                elements.timer.classList.add('timer-low');
            } else {
                elements.timer.classList.remove('timer-low');
            }
        }

        // 6. æ¸¸æˆæ§åˆ¶åŠŸèƒ½
        function showNextWord() {
            if (gameState.currentWordIndex >= gameState.wordsForGame.length) {
                shuffleArray(gameState.wordsForGame);
                gameState.currentWordIndex = 0;
            }
            
            const word = gameState.wordsForGame[gameState.currentWordIndex];
            elements.currentWord.textContent = word;
            gameState.totalWordsShown++;
            updateGameStats();
            gameState.currentWordIndex++;
        }

        function updateGameStats() {
            elements.correctCount.textContent = gameState.correctCount;
            elements.skippedCount.textContent = gameState.skippedCount;
            // elements.totalCount.textContent = gameState.totalWordsShown;
        }

        // 7. æ·»åŠ popInåŠ¨ç”»
        if (!document.querySelector('#pop-animation-style')) {
            const style = document.createElement('style');
            style.id = 'pop-animation-style';
            style.textContent = `
                @keyframes popIn {
                    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                    70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                
                @keyframes rotateCW {
                    from { transform: translate(-50%, -50%) rotate(0deg); }
                    to { transform: translate(-50%, -50%) rotate(360deg); }
                }
                
                @keyframes rotateCCW {
                    from { transform: translate(-50%, -50%) rotate(0deg); }
                    to { transform: translate(-50%, -50%) rotate(-360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // 8. å¢å¼ºmarkCorrectå’ŒskipWordçš„åé¦ˆ
        function markCorrect() {
            gameState.correctCount++;
            showNextWord();
            
            // æ·»åŠ é¢å¤–åé¦ˆ
            elements.currentWord.style.animation = 'none';
            setTimeout(() => {
                elements.currentWord.style.animation = 'pulse 0.5s ease';
            }, 10);
        }

        function skipWord() {
            gameState.skippedCount++;
            showNextWord();
            
            // æ·»åŠ é¢å¤–åé¦ˆ
            elements.currentWord.style.animation = 'none';
            setTimeout(() => {
                elements.currentWord.style.animation = 'shake 0.5s ease';
            }, 10);
        }
        // 9. æ·»åŠ shakeåŠ¨ç”»
        if (!document.querySelector('#shake-animation-style')) {
            const style = document.createElement('style');
            style.id = 'shake-animation-style';
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
                
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            `;
            document.head.appendChild(style);
        }

                // 11. æ·»åŠ é‡ç½®åŸºå‡†è§’åº¦çš„åŠŸèƒ½
        function resetBaselineAngle() {
            console.log('é‡ç½®åŸºå‡†è§’åº¦');
            baselineAlpha = null;
        }

        // 12. åˆå§‹åŒ–æ—¶æä¾›æ ¡å‡†æç¤º
        function initGestureDetection() {
            if (!window.DeviceOrientationEvent) {
                console.log('è®¾å¤‡ä¸æ”¯æŒæ–¹å‘ä¼ æ„Ÿå™¨');
                return;
            }
            
            // iOSæƒé™è¯·æ±‚
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            startGestureListening();
                            showCalibrationHint();
                        } else {
                            console.log('ç”¨æˆ·æ‹’ç»äº†æ–¹å‘ä¼ æ„Ÿå™¨æƒé™');
                        }
                    })
                    .catch(console.error);
            } else {
                startGestureListening();
                showCalibrationHint();
            }
        }
        function showCalibrationHint() {
            const hint = document.createElement('div');
            // hint.innerHTML = `
            //     <div style="text-align: center; padding: 15px;">
            //         <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“±</div>
            //         <div>è¯·ä¿æŒæ‰‹æœºç«–ç›´ä¸åŠ¨</div>
            //         <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">æ­£åœ¨æ ¡å‡†æ–¹å‘ä¼ æ„Ÿå™¨...</div>
            //     </div>
            // `;
            
            hint.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 15px;
                padding: 5px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 9998;
                animation: fadeIn 0.3s ease;
            `;
            
            document.body.appendChild(hint);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                hint.style.opacity = '0';
                hint.style.transition = 'opacity 0.3s ease';
                setTimeout(() => hint.remove(), 300);
            }, 3000);
        }

            // 2. ç®€åŒ–çš„æ‰‹åŠ¿æ£€æµ‹å‡½æ•°
        function startGestureListening() {
            let rotationHistory = []; // å­˜å‚¨è§’åº¦å†å²
            let lastValidTime = 0;
            let baselineAlpha = null; // åŸºå‡†è§’åº¦
            let isCalibrated = false;
            let calibrationSamples = [];
            
            window.addEventListener('deviceorientation', (event) => {
                const currentTime = Date.now();
                const currentAlpha = event.alpha; // Zè½´æ—‹è½¬è§’åº¦
                
                // 1. æ ¡å‡†é˜¶æ®µ - æ”¶é›†åˆå§‹è§’åº¦
                if (!isCalibrated) {
                    calibrationSamples.push(currentAlpha);
                    
                    if (calibrationSamples.length >= 20) { // æ”¶é›†20ä¸ªæ ·æœ¬
                        // è®¡ç®—å¹³å‡å€¼ä½œä¸ºåŸºå‡†
                        const sum = calibrationSamples.reduce((a, b) => a + b, 0);
                        baselineAlpha = sum / calibrationSamples.length;
                        isCalibrated = true;
                        console.log('æ ¡å‡†å®Œæˆï¼ŒåŸºå‡†è§’åº¦:', baselineAlpha);
                    }
                    return;
                }
                
                // 2. é˜²æŠ–å¤„ç†
                if (currentTime - lastValidTime < CONFIG.GESTURE.DEBUNCE_TIME) {
                    return;
                }
                
                // 3. è®¡ç®—ç›¸å¯¹äºåŸºå‡†çš„è§’åº¦
                let relativeAngle = currentAlpha - baselineAlpha;
                
                // è§„èŒƒåŒ–åˆ° [-180, 180] èŒƒå›´
                if (relativeAngle > 180) relativeAngle -= 360;
                if (relativeAngle < -180) relativeAngle += 360;
                
                // 4. ä¿å­˜åˆ°å†å²è®°å½•
                rotationHistory.push({
                    time: currentTime,
                    angle: relativeAngle
                });
                
                // ä¿æŒå†å²è®°å½•å¤§å°
                if (rotationHistory.length > CONFIG.GESTURE.HISTORY_SIZE) {
                    rotationHistory.shift();
                }
                
                // 5. æ£€æµ‹æ—‹è½¬æ‰‹åŠ¿ï¼ˆéœ€è¦è‡³å°‘3ä¸ªæ•°æ®ç‚¹ï¼‰
                if (rotationHistory.length >= 3) {
                    detectSimpleRotation(rotationHistory);
                }
            });
        }
                // 3. ç®€åŒ–çš„æ—‹è½¬æ£€æµ‹
        function detectSimpleRotation(history) {
            const now = Date.now();
            
            // å†·å´æ—¶é—´æ£€æŸ¥
            if (now - gameState.lastGestureTime < CONFIG.GESTURE.COOLDOWN) {
                return;
            }
            
            // å–æœ€è¿‘çš„æ•°æ®ç‚¹
            const recentPoints = history.slice(-4); // å–æœ€è¿‘4ä¸ªç‚¹
            
            // è®¡ç®—è§’åº¦å˜åŒ–
            const firstAngle = recentPoints[0].angle;
            const lastAngle = recentPoints[recentPoints.length - 1].angle;
            const timeDiff = recentPoints[recentPoints.length - 1].time - recentPoints[0].time;
            
            // è®¡ç®—æ€»è§’åº¦å˜åŒ–ï¼ˆè€ƒè™‘360åº¦è¾¹ç•Œï¼‰
            let totalAngleChange = lastAngle - firstAngle;
            if (totalAngleChange > 180) totalAngleChange -= 360;
            if (totalAngleChange < -180) totalAngleChange += 360;
            
            // è®¡ç®—æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
            const rotationSpeed = timeDiff > 0 ? Math.abs(totalAngleChange) / (timeDiff / 1000) : 0;
            
            console.log(`è§’åº¦å˜åŒ–: ${totalAngleChange.toFixed(1)}Â°, é€Ÿåº¦: ${rotationSpeed.toFixed(1)}Â°/ç§’`);
            
            // 4. æ£€æµ‹æ¡ä»¶
            const absAngleChange = Math.abs(totalAngleChange);
            
            // æ¡ä»¶1: è§’åº¦å˜åŒ–è¶³å¤Ÿå¤§
            const isAngleSufficient = absAngleChange >= CONFIG.GESTURE.MIN_ROTATION_ANGLE && 
                                    absAngleChange <= CONFIG.GESTURE.MAX_ROTATION_ANGLE;
            
            // æ¡ä»¶2: æ—‹è½¬é€Ÿåº¦è¶³å¤Ÿå¿«
            const isSpeedSufficient = rotationSpeed >= CONFIG.GESTURE.ROTATION_SPEED_THRESHOLD;
            
            // æ¡ä»¶3: æ£€æŸ¥æ—‹è½¬æ–¹å‘æ˜¯å¦ä¸€è‡´
            const isDirectionConsistent = checkDirectionConsistency(recentPoints);
            
            if (isAngleSufficient && isSpeedSufficient && isDirectionConsistent) {
                // ç¡®å®šæ—‹è½¬æ–¹å‘
                if (totalAngleChange < 0) {
                    // è´Ÿè§’åº¦å˜åŒ– = é¡ºæ—¶é’ˆæ—‹è½¬
                    console.log(`æ£€æµ‹åˆ°é¡ºæ—¶é’ˆæ—‹è½¬: ${absAngleChange.toFixed(1)}Â°`);
                    triggerGesture('clockwise');
                    rotationHistory.length = 0; // æ¸…ç©ºå†å²ï¼Œé¿å…é‡å¤æ£€æµ‹
                } else if (totalAngleChange > 0) {
                    // æ­£è§’åº¦å˜åŒ– = é€†æ—¶é’ˆæ—‹è½¬
                    console.log(`æ£€æµ‹åˆ°é€†æ—¶é’ˆæ—‹è½¬: ${absAngleChange.toFixed(1)}Â°`);
                    triggerGesture('counterclockwise');
                    rotationHistory.length = 0; // æ¸…ç©ºå†å²
                }
            }
        }
        // 3. æ”¹è¿›çš„æ—‹è½¬æ£€æµ‹ç®—æ³•
        function detectRotationGesture(history) {
            const currentTime = Date.now();
            
            // å†·å´æ—¶é—´æ£€æŸ¥
            if (currentTime - gameState.lastGestureTime < CONFIG.GESTURE.COOLDOWN) {
                return;
            }
            
            // åˆ†ææ—‹è½¬æ¨¡å¼
            const recentData = history.slice(-5); // å–æœ€è¿‘5ä¸ªæ•°æ®ç‚¹
            const angles = recentData.map(d => d.angle);
            const speeds = recentData.map(d => d.speed);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„æ—‹è½¬åŠ¨ä½œ
            const maxSpeed = Math.max(...speeds.map(Math.abs));
            if (maxSpeed < CONFIG.GESTURE.ROTATION_SPEED_THRESHOLD) {
                return; // æ—‹è½¬é€Ÿåº¦ä¸å¤Ÿ
            }
            
            // è®¡ç®—è§’åº¦å˜åŒ–èŒƒå›´
            const minAngle = Math.min(...angles);
            const maxAngle = Math.max(...angles);
            const angleRange = maxAngle - minAngle;
            
            if (angleRange < CONFIG.GESTURE.ROTATION_THRESHOLD) {
                return; // æ—‹è½¬è§’åº¦ä¸å¤Ÿ
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯"æ—‹è½¬åæ¢å¤"æ¨¡å¼
            const isReturningToBaseline = checkReturnPattern(angles);
            
            if (isReturningToBaseline) {
                // ç¡®å®šæ—‹è½¬æ–¹å‘
                const rotationPattern = analyzeRotationDirection(history);
                
                if (rotationPattern === 'clockwise') {
                    console.log('æ£€æµ‹åˆ°é¡ºæ—¶é’ˆæ—‹è½¬å¹¶æ¢å¤');
                    triggerGesture('clockwise');
                } else if (rotationPattern === 'counterclockwise') {
                    console.log('æ£€æµ‹åˆ°é€†æ—¶é’ˆæ—‹è½¬å¹¶æ¢å¤');
                    triggerGesture('counterclockwise');
                }
            }
        }
        // 4. æ£€æŸ¥æ–¹å‘ä¸€è‡´æ€§
        function checkDirectionConsistency(points) {
            if (points.length < 3) return true;
            
            let consistentCount = 0;
            for (let i = 1; i < points.length; i++) {
                const angleDiff = points[i].angle - points[i-1].angle;
                
                // æ£€æŸ¥ä¸»è¦æ–¹å‘
                if (Math.abs(angleDiff) > 2) { // å¿½ç•¥å¾®å°å˜åŒ–
                    const firstSign = Math.sign(points[1].angle - points[0].angle);
                    const currentSign = Math.sign(angleDiff);
                    
                    if (firstSign === currentSign) {
                        consistentCount++;
                    }
                }
            }
            
            // è‡³å°‘70%çš„æ•°æ®ç‚¹æ–¹å‘ä¸€è‡´
            return consistentCount >= Math.floor((points.length - 1) * 0.7);
        }
        // 4. æ£€æŸ¥æ˜¯å¦è¿”å›åˆ°åŸºå‡†ä½ç½®
        function checkReturnPattern(angles) {
            if (angles.length < 3) return false;
            
            const recentAngle = angles[angles.length - 1];
            const middleAngle = angles[Math.floor(angles.length / 2)];
            
            // æ£€æŸ¥æ˜¯å¦ä»æç«¯ä½ç½®è¿”å›åˆ°æ¥è¿‘0çš„ä½ç½®
            const middleDeviation = Math.abs(middleAngle);
            const recentDeviation = Math.abs(recentAngle);
            
            // æ¡ä»¶ï¼šä¸­é—´è§’åº¦æœ‰è¾ƒå¤§åç§»ï¼Œæœ€è¿‘è§’åº¦æ¥è¿‘0
            return middleDeviation > CONFIG.GESTURE.ROTATION_THRESHOLD / 2 &&
                recentDeviation < CONFIG.GESTURE.STABILITY_THRESHOLD;
        }

        // 5. åˆ†ææ—‹è½¬æ–¹å‘
        function analyzeRotationDirection(history) {
            // æ‰¾åˆ°æ—‹è½¬å³°å€¼æ—¶åˆ»
            const peakIndex = findPeakIndex(history);
            if (peakIndex === -1) return null;
            
            const peakAngle = history[peakIndex].angle;
            
            // æ ¹æ®å³°å€¼è§’åº¦åˆ¤æ–­æ–¹å‘
            if (peakAngle > 0) {
                // æ­£è§’åº¦ = é€†æ—¶é’ˆæ—‹è½¬
                return 'counterclockwise';
            } else if (peakAngle < 0) {
                // è´Ÿè§’åº¦ = é¡ºæ—¶é’ˆæ—‹è½¬
                return 'clockwise';
            }
            
            return null;
        }

        // 6. æ‰¾åˆ°æ—‹è½¬å³°å€¼
        function findPeakIndex(history) {
            let maxDeviation = 0;
            let peakIndex = -1;
            
            for (let i = 0; i < history.length; i++) {
                const deviation = Math.abs(history[i].angle);
                if (deviation > maxDeviation) {
                    maxDeviation = deviation;
                    peakIndex = i;
                }
            }
            
            return peakIndex;
        }

        // 6. ä¼˜åŒ–triggerGestureå‡½æ•°
        function triggerGesture(direction) {
            const now = Date.now();
            const cooldown = gameState.lastGestureTime ? CONFIG.GESTURE.COOLDOWN : 0;
            
            if (now - gameState.lastGestureTime < cooldown) {
                console.log('æ‰‹åŠ¿å†·å´ä¸­...');
                return;
            }
            
            gameState.lastGestureTime = now;
            
            // æä¾›å³æ—¶è§†è§‰åé¦ˆ
            const feedback = document.createElement('div');
            feedback.className = 'instant-feedback';
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 4rem;
                z-index: 9999;
                pointer-events: none;
                animation: popIn 0.3s ease-out;
            `;
            
            if (direction === 'clockwise') {
                feedback.textContent = 'âœ…';
                feedback.style.color = '#2ed573';
                console.log('è§¦å‘ï¼šé¡ºæ—¶é’ˆæ—‹è½¬ - çŒœå¯¹');
                setTimeout(() => markCorrect(), 50); // å»¶è¿Ÿ50msæ‰§è¡Œï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
            } else {
                feedback.textContent = 'â­ï¸';
                feedback.style.color = '#ff9f43';
                console.log('è§¦å‘ï¼šé€†æ—¶é’ˆæ—‹è½¬ - è·³è¿‡');
                setTimeout(() => skipWord(), 50);
            }
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transition = 'opacity 0.2s ease';
                setTimeout(() => feedback.remove(), 200);
            }, 300);
        }

        // 8. æ·»åŠ æ—‹è½¬åŠ¨ç”»åé¦ˆ
        function showRotationAnimation(direction) {
            const feedback = document.createElement('div');
            feedback.className = 'rotation-feedback';
            
            const emoji = direction === 'clockwise' ? 'ğŸ”„' : 'â†ªï¸';
            const text = direction === 'clockwise' ? 'é¡ºæ—¶é’ˆæ—‹è½¬ - çŒœå¯¹' : 'é€†æ—¶é’ˆæ—‹è½¬ - è·³è¿‡';
            const color = direction === 'clockwise' ? '#2ed573' : '#ff9f43';
            
            feedback.innerHTML = `
                <div style="font-size: 3.5rem; animation: ${direction === 'clockwise' ? 'rotateClockwise' : 'rotateCounterclockwise'} 0.6s ease">
                    ${emoji}
                </div>
                <div style="font-size: 1.1rem; margin-top: 8px; font-weight: bold; color: ${color}">
                    ${text}
                </div>
            `;
            
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 9999;
                background: rgba(255, 255, 255, 0.95);
                padding: 20px 30px;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                pointer-events: none;
            `;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    feedback.remove();
                }, 300);
            }, 800);
        }

        // 9. æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes rotateClockwise {
                0% { transform: rotate(0deg) scale(0.8); opacity: 0.5; }
                50% { transform: rotate(180deg) scale(1.2); opacity: 1; }
                100% { transform: rotate(360deg) scale(1); opacity: 0; }
            }
            
            @keyframes rotateCounterclockwise {
                0% { transform: rotate(0deg) scale(0.8); opacity: 0.5; }
                50% { transform: rotate(-180deg) scale(1.2); opacity: 1; }
                100% { transform: rotate(-360deg) scale(1); opacity: 0; }
            }
            
            .rotation-feedback {
                animation: fadeInOut 0.8s ease;
            }
            
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); }
            }
        `;
        document.head.appendChild(style);

        function handleGesture(direction) {
            const now = Date.now();
            if (now - gameState.lastGestureTime < CONFIG.GESTURE.COOLDOWN) return;
            
            gameState.lastGestureTime = now;
            
            if (direction === 'clockwise') {
                console.log('é¡ºæ—¶é’ˆæ‰‹åŠ¿ - çŒœå¯¹');
                markCorrect();
            } else if (direction === 'counterclockwise') {
                console.log('é€†æ—¶é’ˆæ‰‹åŠ¿ - è·³è¿‡');
                skipWord();
            }
        }

        function showGestureFeedback(emoji, color) {
            const feedback = document.createElement('div');
            feedback.className = 'gesture-feedback';
            feedback.innerHTML = `
                <div style="font-size: 4rem;">${emoji}</div>
                <div style="font-size: 1.2rem; margin-top: 10px; font-weight: bold;">
                    ${emoji === 'âœ…' ? 'é¡ºæ—¶é’ˆæ—‹è½¬ - çŒœå¯¹' : 'ğŸ”„ é€†æ—¶é’ˆæ—‹è½¬ - è·³è¿‡'}
                </div>
            `;
            feedback.style.color = color;
            feedback.style.textAlign = 'center';
            feedback.style.background = 'rgba(255, 255, 255, 0.95)';
            feedback.style.padding = '20px';
            feedback.style.borderRadius = '20px';
            feedback.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 800);
        }

        // 8. æ¸¸æˆç»“æŸ
        function endGame() {
            clearInterval(gameState.timer);
            
            const score = gameState.correctCount * 1;
            elements.finalScore.textContent = score;
            elements.finalCorrect.textContent = gameState.correctCount;
            elements.finalSkipped.textContent = gameState.skippedCount;
            elements.finalTotal.textContent = gameState.totalWordsShown;
            
            let message = '';
            if (score >= 80) message = 'å¤ªå‰å®³äº†ï¼ä½ æ˜¯çŒœè¯å¤§å¸ˆï¼';
            else if (score >= 50) message = 'ä¸é”™å“¦ï¼ç»§ç»­åŠªåŠ›ï¼';
            else if (score >= 30) message = 'ç»§ç»­åŠ æ²¹ï¼Œä¸‹æ¬¡ä¼šæ›´å¥½ï¼';
            else message = 'å¤šç©å‡ æ¬¡ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼';
            
            elements.resultMessage.textContent = message;
            showSection('result');
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function showSection(section) {
            document.querySelectorAll('.game-section').forEach(el => {
                el.classList.remove('active-section');
            });
            
            const target = document.getElementById(section + 'Section');
            if (target) target.classList.add('active-section');
        }

        function showLoader(show) {
            elements.loader.style.display = show ? 'block' : 'none';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // é»˜è®¤è¯è¯­æ•°æ®ï¼ˆå¤‡ç”¨ï¼‰
        function getDefaultWords(filename) {
            const defaults = {
                'idiom.txt': [],
                'star.txt': [],
                'food.txt': [],
                'sport.txt': [],
                'movie.txt': [],
                'animal.txt': []
            };
            return defaults[filename] || [];
        }

        function getDefaultThemes() {
            return [
                {
                    id: 'idiom',
                    name: 'æˆè¯­',
                    icon: 'fas fa-book-open',
                    color: '#2575fc',
                    words: getDefaultWords('idiom.txt')
                },
                {
                    id: 'star',
                    name: 'æ˜æ˜Ÿ',
                    icon: 'fas fa-star',
                    color: '#ff9f43',
                    words: getDefaultWords('star.txt')
                }
            ];
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('correctBtn').addEventListener('click', markCorrect);
        document.getElementById('skipBtn').addEventListener('click', skipWord);
        document.getElementById('endGameBtn').addEventListener('click', endGame);
        document.getElementById('playAgainBtn').addEventListener('click', () => showSection('theme'));
        document.getElementById('backToThemeBtn').addEventListener('click', () => showSection('theme'));

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', () => {
            initAllThemes();
            
            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.7; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>